# EVè¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

EVãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æã—ã€æ¬¡å›ã®é•·æœŸæ”¾ç½®å ´æ‰€ã¨Î”SOCã‚’äºˆæ¸¬ã™ã‚‹ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã™ã€‚

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
eda_behavior_analysis/
â”œâ”€â”€ README.md                        # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ behavior_analysisè¦ä»¶.md         # è©³ç´°è¦ä»¶å®šç¾©
â”‚
â”œâ”€â”€ config.py                        # è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆBehaviorAnalysisConfigï¼‰
â”œâ”€â”€ time_processor.py                # æ™‚é–“ç¯„å›²å‡¦ç†ï¼ˆ06:00èµ·ç‚¹ã®æ—¥ç•Œå‡¦ç†ï¼‰
â”œâ”€â”€ vectorizer.py                    # Step1: æ—¥æ¬¡è¡Œå‹•ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆ
â”œâ”€â”€ clusterer.py                     # Step2: è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°
â”œâ”€â”€ map_visualizer.py                # Step3: åœ°å›³å¯è¦–åŒ–ï¼ˆFoliumï¼‰
â”œâ”€â”€ utils.py                         # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
â”‚
â”œâ”€â”€ behavior_analysis_pipeline.py   # ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ±åˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆå†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰
â””â”€â”€ behavior_analysis.ipynb         # ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯
```

## ğŸš€ ä½¿ã„æ–¹

### 1. ç’°å¢ƒæ§‹ç¯‰

```bash
pip install pandas numpy scikit-learn matplotlib seaborn folium hdbscan
```

### 2. ãƒ‡ãƒ¼ã‚¿æº–å‚™

ä»¥ä¸‹ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ï¼š
- `ev_sessions_1.csv`: ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿
- `ev_sessions_0.csv`: å…ƒãƒ‡ãƒ¼ã‚¿ï¼ˆåœ°å›³å¯è¦–åŒ–ç”¨ã€movingã‚»ãƒƒã‚·ãƒ§ãƒ³å«ã‚€ï¼‰

### 3. Jupyter Notebookã§å®Ÿè¡Œ

`behavior_analysis.ipynb` ã‚’é–‹ã„ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

#### Step 0: è¨­å®š

```python
from behavior_analysis_pipeline import (
    BehaviorAnalysisConfig,
    DailyBehaviorVectorizer,
    BehaviorPatternClusterer,
    load_session_data
)

# è¨­å®š
config = BehaviorAnalysisConfig(
    hour_bin_size=1,                     # æ™‚é–“ãƒ“ãƒ³ã‚µã‚¤ã‚ºï¼ˆæ™‚é–“ï¼‰
    topK_clusters=20,                    # ä¸Šä½Kå€‹ã®ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½¿ç”¨
    topK_transitions=15,                 # ä¸Šä½Kå€‹ã®é·ç§»ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
    clustering_method='kmeans',          # 'kmeans' or 'hdbscan'
    include_transition_features=True,    # é·ç§»ç‰¹å¾´é‡ã‚’å«ã‚ã‚‹
    k_range=(3, 10),                     # KMeansã®kå€¤æ¢ç´¢ç¯„å›²
    random_state=42
)
```

#### Step 1: æ—¥æ¬¡è¡Œå‹•ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆ

```python
# ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
df_sessions = load_session_data('ev_sessions_1.csv')

# æ—¥æ¬¡è¡Œå‹•ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆ
vectorizer = DailyBehaviorVectorizer(config)
daily_vectors = vectorizer.fit_transform(df_sessions)
```

**å‡ºåŠ›:**
- `daily_vectors`: hashvin Ã— date06 ã®è¡Œå‹•ãƒ™ã‚¯ãƒˆãƒ«
- æ»åœ¨ç‰¹å¾´é‡: `ratio__{hour_bin}__{cluster}`
- é·ç§»ç‰¹å¾´é‡: `trans__{from}--{to}`, `trans_count_{period}`

#### Step 2: è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°

```python
# hashvinã”ã¨ã«ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°
clusterer = BehaviorPatternClusterer(config)

results = {}
for hashvin in daily_vectors.index.get_level_values('hashvin').unique():
    df_clustered = clusterer.fit_transform(daily_vectors, hashvin)
    results[hashvin] = df_clustered
```

**å‡ºåŠ›:**
- å„æ—¥ã«è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¯ãƒ©ã‚¹ã‚¿IDï¼ˆ`day_pattern_cluster`ï¼‰ãŒä»˜ä¸ã•ã‚Œã‚‹
- KMeansã¾ãŸã¯HDBSCANã§è‡ªå‹•ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°

#### Step 3: åœ°å›³å¯è¦–åŒ–

```python
from map_visualizer import BehaviorMapVisualizer

# å…ƒãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆmovingã‚»ãƒƒã‚·ãƒ§ãƒ³å«ã‚€ï¼‰
df_sessions_0 = pd.read_csv('ev_sessions_0.csv')

# å¯è¦–åŒ–
visualizer = BehaviorMapVisualizer(
    lat_col='start_lat',
    lon_col='start_lon',
    end_lat_col='end_lat',  # movingç”¨
    end_lon_col='end_lon'   # movingç”¨
)

# åœ°å›³ä½œæˆ
test_hashvin = 'hv_0001_demo'
behavior_map = visualizer.create_behavior_map(
    sessions_df=df_sessions_0,
    hashvin=test_hashvin,
    daily_vectors_with_clusters=results[test_hashvin],
    output_path=f'outputs/behavior_map_{test_hashvin}.html'
)
```

**åœ°å›³ã®æ©Ÿèƒ½:**
- â±ï¸ **ã‚¿ã‚¤ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼**: æ—¥ä»˜ã‚’å‰å¾Œã«åˆ‡ã‚Šæ›¿ãˆï¼ˆå‰æ—¥ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã‚‹ï¼‰
- ğŸ·ï¸ **ã‚¯ãƒ©ã‚¹ã‚¿IDãƒ©ãƒ™ãƒ«**: ãƒãƒ¼ã‚«ãƒ¼ã«å¸¸æ™‚è¡¨ç¤º
- ğŸ…¿ï¸ **é’è‰²ãƒãƒ¼ã‚«ãƒ¼**: æ”¾ç½®ã‚»ãƒƒã‚·ãƒ§ãƒ³
- âš¡ **èµ¤è‰²ãƒãƒ¼ã‚«ãƒ¼**: å……é›»ã‚»ãƒƒã‚·ãƒ§ãƒ³
- ğŸš— **ç·‘è‰²ãƒãƒªãƒ©ã‚¤ãƒ³**: ç§»å‹•ã‚»ãƒƒã‚·ãƒ§ãƒ³
- ğŸ“ **GoogleMapsãƒªãƒ³ã‚¯**: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰ç›´æ¥ã‚¸ãƒ£ãƒ³ãƒ—

## ğŸ“Š å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿

### æ—¥æ¬¡è¡Œå‹•ãƒ™ã‚¯ãƒˆãƒ« (`daily_vectors`)

| ã‚«ãƒ©ãƒ  | èª¬æ˜ |
|--------|------|
| `hashvin` | è»Šä¸¡IDï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ |
| `date06` | 06:00èµ·ç‚¹ã®æ—¥ä»˜ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰ |
| `ratio__{hour_bin}__{cluster}` | æ™‚é–“å¸¯Ã—ã‚¯ãƒ©ã‚¹ã‚¿ã®æ»åœ¨æ¯”ç‡ |
| `ratio_OTHER__{hour_bin}` | ãã®ä»–ã‚¯ãƒ©ã‚¹ã‚¿ã®æ»åœ¨æ¯”ç‡ |
| `trans__{from}--{to}` | é·ç§»ãƒ‘ã‚¿ãƒ¼ãƒ³å‡ºç¾å›æ•° |
| `trans_count_{period}` | æ™‚é–“å¸¯åˆ¥é·ç§»æ•° |
| `trans_count_total` | ç·é·ç§»æ•° |
| `unique_clusters_visited` | ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¯ãƒ©ã‚¹ã‚¿è¨ªå•æ•° |
| `total_minutes` | ç·æ»åœ¨æ™‚é–“ |
| `weekday` | æ›œæ—¥ï¼ˆ0=æœˆæ›œï¼‰ |
| `is_empty_day` | ç©ºæ—¥ãƒ•ãƒ©ã‚° |

### ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°çµæœ (`results[hashvin]`)

æ—¥æ¬¡è¡Œå‹•ãƒ™ã‚¯ãƒˆãƒ«ã«ä»¥ä¸‹ãŒè¿½åŠ ï¼š
- `day_pattern_cluster`: è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¯ãƒ©ã‚¹ã‚¿ID

## ğŸ¯ ä¸»è¦æ©Ÿèƒ½

### 1. 06:00èµ·ç‚¹ã®æ—¥ç•Œå‡¦ç†

ç¡çœ å‘¨æœŸã‚’è€ƒæ…®ã—ã€06:00ã‚’æ—¥ã®å¢ƒç•Œã¨ã—ã¦å®šç¾©ã€‚
- 2025-10-23 20:00 â†’ 2025-10-23 06:00ã®æ—¥
- 2025-10-23 03:00 â†’ 2025-10-22 06:00ã®æ—¥

### 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†å‰²

æ—¥ã‚’ã¾ãŸãã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•åˆ†å‰²ã—ã€å„æ—¥ã«æŒ‰åˆ†ã€‚

### 3. æ™‚é–“ãƒ“ãƒ³æŒ‰åˆ†

1æ™‚é–“ï¼ˆè¨­å®šå¯èƒ½ï¼‰ã”ã¨ã«æ»åœ¨æ™‚é–“ã‚’æŒ‰åˆ†ã€‚

### 4. ä¸Šä½ã‚¯ãƒ©ã‚¹ã‚¿é¸å®š

æ»åœ¨æ™‚é–“ã®å¤šã„ä¸Šä½Kå€‹ã®ã‚¯ãƒ©ã‚¹ã‚¿ã«ç„¦ç‚¹ã‚’å½“ã¦ã€æ®‹ã‚Šã¯`OTHER`ã«é›†ç´„ã€‚

### 5. é·ç§»ç‰¹å¾´é‡

å ´æ‰€é–“ã®ç§»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç‰¹å¾´é‡åŒ–ï¼š
- ä¸Šä½Kå€‹ã®é·ç§»ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‡ºç¾å›æ•°
- æ™‚é–“å¸¯åˆ¥ã®é·ç§»æ•°ï¼ˆæœ/æ˜¼/å¤•/å¤œï¼‰
- ç·é·ç§»æ•°ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¯ãƒ©ã‚¹ã‚¿è¨ªå•æ•°

### 6. è‡ªå‹•ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°

**KMeans:**
- Silhouetteã€Calinski-Harabaszã€Davies-Bouldinã‚¹ã‚³ã‚¢ã§æœ€é©kå€¤ã‚’è‡ªå‹•é¸æŠ

**HDBSCAN:**
- ã‚¯ãƒ©ã‚¹ã‚¿æ•°ã‚’è‡ªå‹•æ¤œå‡º
- ãƒã‚¤ã‚ºç‚¹ã®è­˜åˆ¥

### 7. ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–åœ°å›³

**æ—¥ä»˜åˆ‡ã‚Šæ›¿ãˆ:**
- å‰æ—¥/æ¬¡æ—¥ãƒœã‚¿ãƒ³
- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ç›´æ¥é¸æŠ
- **å‰æ—¥ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«æ¶ˆãˆã‚‹**

**ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º:**
- **ã‚¯ãƒ©ã‚¹ã‚¿IDãŒå¸¸æ™‚è¡¨ç¤º**ï¼ˆé»„è‰²ãƒ©ãƒ™ãƒ«ï¼‰
- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§è©³ç´°æƒ…å ±
- GoogleMapsãƒªãƒ³ã‚¯

## âš™ï¸ è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³

### BehaviorAnalysisConfig

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|-----------|-----------|------|
| `hour_bin_size` | 1 | æ™‚é–“ãƒ“ãƒ³ã‚µã‚¤ã‚ºï¼ˆæ™‚é–“ï¼‰ |
| **`use_topk_per_hour`** | **True** | **æ™‚é–“å¸¯ã”ã¨TOP-Kæ–¹å¼ã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰** |
| **`topk_per_hour`** | **3** | **å„æ™‚é–“å¸¯ã®TOP-Kã‚¯ãƒ©ã‚¹ã‚¿æ•°** |
| `topK_clusters` | 20 | ä¸Šä½ã‚¯ãƒ©ã‚¹ã‚¿æ•°ï¼ˆå¾“æ¥æ–¹å¼ç”¨ï¼‰ |
| `topK_transitions` | 15 | ä¸Šä½é·ç§»ãƒ‘ã‚¿ãƒ¼ãƒ³æ•° |
| `clustering_method` | 'kmeans' | 'kmeans' or 'hdbscan' |
| `k_range` | (3, 10) | KMeansã®kå€¤æ¢ç´¢ç¯„å›² |
| `hdbscan_min_cluster_size` | 5 | HDBSCANã®æœ€å°ã‚¯ãƒ©ã‚¹ã‚¿ã‚µã‚¤ã‚º |
| `hdbscan_min_samples` | 3 | HDBSCANã®æœ€å°ã‚µãƒ³ãƒ—ãƒ«æ•° |
| `include_transition_features` | True | é·ç§»ç‰¹å¾´é‡ã‚’å«ã‚ã‚‹ã‹ |
| `day_start_hour` | 6 | æ—¥ã®é–‹å§‹æ™‚åˆ» |
| `random_state` | 42 | ä¹±æ•°ã‚·ãƒ¼ãƒ‰ |
| `timezone` | 'Asia/Tokyo' | ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ |

## ğŸ“ˆ å¯è¦–åŒ–ä¾‹

Jupyter Notebookã§ã¯ä»¥ä¸‹ã‚’å¯è¦–åŒ–ï¼š
- ã‚¯ãƒ©ã‚¹ã‚¿ã”ã¨ã®å¹³å‡è¡Œå‹•ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
- æ›œæ—¥åˆ†å¸ƒ
- ä»£è¡¨æ—¥ã®è©³ç´°åˆ†æ
- ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–åœ°å›³ï¼ˆHTMLå‡ºåŠ›ï¼‰

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ImportError: No module named 'hdbscan'

```bash
pip install hdbscan
```

### åœ°å›³ãŒè¡¨ç¤ºã•ã‚Œãªã„

- `outputs/behavior_map_{hashvin}.html` ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§ç›´æ¥é–‹ã„ã¦ãã ã•ã„
- JavaScriptãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„

### ã‚¯ãƒ©ã‚¹ã‚¿IDãŒã€ŒN/Aã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹

- `ev_sessions_1.csv` ã« `session_cluster` ã‚«ãƒ©ãƒ ãŒã‚ã‚‹ã‹ç¢ºèª
- ã¾ãŸã¯ `daily_vectors_with_clusters` ã‚’æ­£ã—ãæ¸¡ã—ã¦ã„ã‚‹ã‹ç¢ºèª

## ğŸ“ æ›´æ–°å±¥æ­´

- **2025-10-23**: åˆç‰ˆä½œæˆ
  - Step1: æ—¥æ¬¡è¡Œå‹•ãƒ™ã‚¯ãƒˆãƒ«ç”Ÿæˆ
  - Step2: è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°
  - Step3: åœ°å›³å¯è¦–åŒ–ï¼ˆFoliumï¼‰
  - é·ç§»ç‰¹å¾´é‡ã®è¿½åŠ 
  - HDBSCANå¯¾å¿œ
  - ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰æ•´ç†
  - åœ°å›³ã®ã‚¯ãƒ©ã‚¹ã‚¿IDãƒ©ãƒ™ãƒ«è¡¨ç¤º
  - ä¸€æ—¥ãšã¤ã®åœ°å›³è¡¨ç¤ºï¼ˆå‰æ—¥ãƒ‡ãƒ¼ã‚¿è‡ªå‹•å‰Šé™¤ï¼‰

## ğŸ“§ ãŠå•ã„åˆã‚ã›

è³ªå•ã‚„ä¸æ˜ç‚¹ãŒã‚ã‚Œã°ã€é–‹ç™ºè€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
