# EVユーザー行動パターン分析 要件（Step1–Step2）

## 目的・背景・いま取り組む理由
- **最終目的**：充電時に「次の長時間放置先」と「そこまでのΔSOC（消費SOC）」を高精度に予測し、**放置開始時に高SOCにならない**よう充電量をレコメンドする。
- **現状の課題**：曜日・時刻などの静的特徴だけでは、**同じ曜日/時刻でも異なる“行動文脈”**（通勤/外出/帰宅/寄り道 等）を十分に説明できず、放置場所予測の精度に限界がある。
- **着眼点**：「**どの時間帯にどの場所に滞在していたか**」という**日内リズム（時間×場所の構造）**が、放置先の選択を強く規定する。
- **先に行動分析をやる理由**：
  - 直近6hなどの“手軽な特徴量”を後で設計するために、**なぜその時間帯・場所が効くのか**を**説明可能**にする必要がある。
  - まず**一日単位**で行動をベクトル化・クラスタリングし、**パターンの軸（通勤・在宅・外出など）**を可視化/定量化することで、後段の特徴設計（直前6h等）に**根拠**を与える。
- **1日の定義（重要）**：日界は**06:00起点の24時間（06:00〜翌06:00）**  
  - 目的：夜間の越日を“同一日の行動”として扱い、**睡眠→通勤→帰宅→就寝**の1サイクルを一枚に収める。

---

## 前提・共通ルール
- **対象データ**：公共充電（自宅100Vは除外）。よく利用する充電ステーションが主対象。
- **クラスタ**：緯度経度からDBSCANで得た`session_cluster`（例：`I_0`,`I_1`,`C_1`）。  
  `Home/Work`などの**人手ラベルは不要**（機械的な日内滞在特性で擬似判定は可能）。
- **セッション種別**：`session_type ∈ {inactive, charging}`（`moving`は任意活用。無くても可）
- **時間帯分割**：基本は**1時間ビン（24bin）**。必要に応じて**2h/3h/4h**も切替可能（パラメータ化）。
- **学習期間**：**直近3か月**を1ウィンドウとして分析（ロールさせ季節/ライフイベント変化を追跡）。

---

# Step1｜日次行動ベクトルの生成（06:00起点の24h）

### 目的
- `hashvin × date06`（06:00起点で切った“日”）ごとに、**時間帯×場所（クラスタ）**の滞在構造を**数値ベクトル**化する。
- 後段のクラスタリング（Step2）と、将来の“直前6h特徴”設計の**根拠**を提供。

### 入力データ（セッション行）
必須カラム（型）
- `hashvin` (str)
- `session_id` (str/int)
- `session_type` (str; `"inactive"` or `"charging"`。`"moving"`は任意)
- `session_cluster` (str; 例:`I_0`,`C_1`…)
- `start_time`, `end_time` (tz-aware datetime; JST推奨)
- `duration_minutes` (float/int; 20分未満は除外済みが望ましい)
- `start_lat`, `start_lon`, `end_lat`, `end_lon` (float)
- `distance_m` (float; 任意・無ければNaN可)

### 出力データ（行動ベクトル・日次行）
インデックス
- `(hashvin, date06)`  
  - `date06`: その日の**06:00**を起点とする日付キー（例：2025-10-23の06:00〜翌06:00）

カラム（例）
- **滞在比率ベクトル**：`ratio__{hour_bin}__{session_cluster}`  
  - 例：`ratio__07-08__I_0`, `ratio__18-19__C_1` …（**1h刻み×クラスタ**）
  - 値域：**0〜1**（その日合計で正規化）
- **集約列（任意）**：  
  - `ratio_OTHER__{hour_bin}`（上位Kクラスタ以外の合算）  
  - `total_minutes`（その日対象セッション合計）  
  - `weekday`（0=Mon…6=Sun。起点06:00側の暦日で定義）

### 処理仕様（厳密）
1. **日界の再定義**：各セッションを、`[06:00, 翌06:00)`の**日バケット**に分配。越日セッションは**またいだ分を分割**。
2. **時間ビン割当**：各セッションを**1hビン**に細分し、**重なり時間（分）**を正確に按分。
3. **クラスタ×時間帯の集計**：  
   - 単位：分  
   - 欠損は0扱い、重複なし。`charging`も**滞在**としてカウント（“充電中にどこにいたか”を持つため）。
4. **上位Kクラスタ採択＋OTHER**：  
   - 直近3か月内で滞在分数の多い**上位K（例：K=20）**を列として固定化。  
   - それ以外は`OTHER`へ集約（疎行列・長尾対策）。
5. **正規化**：行（その日）で合計を1にスケーリング（**滞在比率**）。  
   - 合計0（データ欠落等）は全0ベクトル＆フラグ列`is_empty_day=1`を付与（解析時除外可）。
6. **品質チェック（必須）**：  
   - 行ごとの合計が**1±1e-6**内か検証。  
   - `sum_{clusters}(ratio__h__*)`が**各時間帯で≤1**を保証（同時重複がないか確認）。

### パラメータ（可変）
- `hour_bin_size`: `1h`（推奨）/ `2h` / `3h` / `4h`
- `topK_clusters`: `20`（目安：主要放置5＋長尾対応）
- `min_session_minutes`: `20`（短停止ノイズ除外の目安）
- `window_months`: `3`（ロール分析の期間）

### 期待される“読み解き”
- **平日通勤型**：日中に`work様クラスタ`比率↑、夜間`home様クラスタ`比率↑  
- **在宅型**：全時間帯で`home様クラスタ`比率が高い  
- **外出/買い物型**：午後〜夕方に`home以外`比率↑  
- **充電習慣**：特定時間帯の`C_*`比率が周期的に出現

---

# Step2｜日次行動のクラスタリング（パターン抽出）

### 目的
- Step1で得た**日次行動ベクトル**をもとに、**行動パターン（通勤/在宅/外出…）**を抽出。  
- 曜日や季節（3か月ウィンドウ）との関連を定量化。  
- 後段の**放置場所予測で“効く時間帯・滞在要素”**を特定し、**直前6h特徴**に還元する根拠を作る。

### 入力
- Step1の出力：`daily_vector`（`(hashvin, date06)`行 × `ratio__{hour}__{cluster}`列）
- 付随メタ：`weekday`, `total_minutes`, `is_empty_day` など

### 出力
1. **パターンID付与**  
   - `day_pattern_cluster`（整数ID）を`(hashvin, date06)`に付与  
   - **hashvinごと・ウィンドウごと**にクラスタリングを実施（個別の生活リズムを抽出）
2. **クラスタプロファイル**  
   - 各クラスタの**平均ヒートマップ**（時間×主要クラスタ）  
   - `weekday`分布（平日/休日・曜日別比率）  
   - `charging`発生率（任意集計）
3. **モデル設計への示唆**  
   - クラスタ間の**寄与の大きい時間帯×場所**を列挙（例：`home@20-24`, `work@08-16`）  
   - これを“直前6h”等へ縮約する**候補特徴**リスト

### 実装要件（手順）
1. **スコーピング**  
   - 対象：単一`hashvin` × 直近`window_months=3`の`daily_vector`  
   - `is_empty_day=1`は除外
2. **前処理**  
   - 列標準化：`StandardScaler`（比率ベクトルだが、クラスタ間の分散差を均す）  
   - 次元削減（可視化用）：`PCA(n_components=2 or 3)`（可）
3. **クラスタリング**  
   - 方式：`KMeans`（初期分析に適、解釈容易）  
     - `k`は**自動最適化**（候補k=3..10）  
     - 指標：**Silhouette（高いほど良）/ Calinski–Harabasz（高）/ Davies–Bouldin（低）**  
     - 合成ランキングで最良kを選択  
   - 代替：データ分布に“ノイズ日”が多い場合は**HDBSCAN**で自動k＋ノイズ分離
4. **結果付与**  
   - `(hashvin, date06) → day_pattern_cluster` を出力テーブルとして保存  
   - 代表日抽出：各クラスタで平均ベクトルに最も近い**代表日**（1〜3件）
5. **報告・可視化**  
   - **クラスタ別ヒートマップ**（時間×主要クラスタ）  
   - **曜日ヒストグラム**（クラスタ別）  
   - **3か月ロール**でのクラスタ比率推移（季節性・生活変化の把握）
6. **設計示唆の抽出**（重要）  
   - クラスタ間の差が**最大**となる「時間帯×クラスタ」を列挙  
     - 例：`(20-24, home様)`, `(08-16, work様)`, `(16-20, mall様)`  
   - 後段の“手軽な特徴”に縮約：  
     - `home_ratio_18_24`, `work_ratio_08_16`, `away_ratio_12_20` など  
   - 放置先との連関チェック（任意）：  
     - クラスタ別の**次回放置クラスタ分布**  
     - → 放置場所予測で効く“行動型×時間帯”を優先して特徴化

### パラメータ（可変）
- `k_range`: `3..10`（データ量や多様性で調整）
- `min_cluster_size`（HDBSCAN使用時）：`5〜15`
- `topK_clusters`（Step1継承）：`20`
- `hour_bin_size`（Step1継承）：`1h`（解析コスト次第で2h/3hへ変更可）

### 品質保証・チェックリスト
- **再現性**：`random_state`固定／パラメータロギング（k, 指標, topK など）
- **安定性**：ウィンドウを±1週間ずらしてもクラスタ構造が大きく崩れないか確認
- **解釈性**：代表日の行動系列（クラスタ遷移）を併記して、業務側が納得できる説明を付与
- **汎用性**：hashvin間で“似たクラスタ構造”が出るかを横比較（必要なら共通辞書化）

---

# Step3｜地図ベース行動分析（folium可視化）【実装は後回し】

### 目的
- Step2で分類された**各行動パターン（day_pattern_cluster）**に属する代表日について、**実際の移動・滞在行動を地図上で可視化**し、定性的な解釈可能性を高める。
- クラスタリング結果の妥当性を視覚的に検証し、業務サイドへの説明材料とする。

### 入力データ
- セッションデータ（`hashvin`, `session_type`, `session_cluster`, `start_time`, `end_time`, `start_lat`, `start_lon`, `end_lat`, `end_lon`, `duration_minutes`, `start_soc`, `end_soc`, `change_soc`）
- Step2の結果（`day_pattern_cluster`が付与された日次データ）
- 代表日リスト（各クラスタから1〜3日）

### 実装要件
1. **地図初期化**  
   - `folium.Map`でベースマップを作成（中心は代表日の平均緯度経度）
   - タイル：OpenStreetMap / CartoDB Positron（読みやすさ重視）

2. **セッションのピン表示**  
   - **inactive（放置）セッション**：青色マーカー  
     - ポップアップ内容：  
       - クラスタID (`session_cluster`)  
       - 開始時刻 / 終了時刻  
       - 滞在時間 (`duration_minutes`)  
       - 開始SOC / 終了SOC / 差分SOC  
       - 緯度経度（クリックでGoogleマップへのリンク）  
   - **charging（充電）セッション**：赤色マーカー  
     - ポップアップ内容：inactive + 充電量（`change_soc`）を強調 
       - 開始時刻 / 終了時刻  
       - 滞在時間 (`duration_minutes`)  
       - 開始SOC / 終了SOC / 差分SOC  
       - 緯度経度（クリックでGoogleマップへのリンク）   
   - **moving（移動）セッション**（データに存在する場合）：  
     - ピンは立てず、**ポリライン**で走行ルートを描画（緑色）  
     - ポップアップ：移動開始→終了時刻、距離（`distance_m`）

3. **Googleマップリンク生成**  
   - ポップアップ内に`<a href="https://www.google.com/maps?q={lat},{lon}" target="_blank">Google Mapsで開く</a>`を埋め込み

4. **時系列表示**  
   - セッションを時系列順にソートし、マーカーに番号ラベル（1, 2, 3...）を付与  
   - 色の濃淡やアイコンサイズで時間経過を表現（任意）

5. **クラスタ別色分け（任意・高度化）**  
   - `session_cluster`ごとに異なる色を割り当て（上位10クラスタ程度）  
   - 凡例を地図上に表示

### 出力
- HTMLファイル（`behavior_map_{hashvin}_{date06}_cluster{n}.html`）  
- ノートブック上でインライン表示（`display(map)`）

### パラメータ
- `zoom_start`: `12`（都市スケール）
- `max_sessions_per_map`: `50`（表示過多を防ぐ上限）

### 期待される分析効果
- **通勤パターン**：自宅様クラスタ→職場様クラスタ→自宅様の往復が明確に視覚化
- **在宅パターン**：ほぼ1箇所（自宅様クラスタ）に終日滞在
- **外出パターン**：複数の異なるクラスタを訪問
- **充電習慣**：特定の充電クラスタ（`C_*`）への定期的な訪問

---

## この後（Step4以降）への接続
- Step2の"有効時間帯×場所"を根拠に、**直前6h/3hの縮約特徴**を設計（例：`home_ratio_last6h`, `work_ratio_last6h`, `unique_clusters_last3h`等）。  
- それらを**放置場所予測（第1段）**の特徴に投入し、**ΔSOC予測（第2段）**へ繋ぐ。  
- 3か月ロールで行動型が変わるユーザーにも追従可能（モデル再学習または特徴の動的更新）。

---

**補足**：`Home/Work`の人手ラベルは不要です。  
クラスタ名はDBSCANのIDのままで構いません。**行動ベクトルの"時間×場所の配置"**から自動的に**home様 / work様 / away様**の性質が浮き上がります。  
この客観的な構造理解が、後段の"手軽で効く特徴"へ確実に変換できる道筋です。
