# 放置前最適充電SOCレコメンド PoCに向けた代表hashvin選定とデータ処理ステップ

## Step 0. 前提整理
- hashvin ≈ 10,000台
- 5分周期データ × 1年分 → 数十億レコード規模
- PoCでは「代表例（10人未満）」を対象に**精査しやすい分析**を行う
- 最終的にはユーザー（hashvin）ごとに予測モデルを展開

---

## Step 1. セクション定義
- 1セクション =  
  `充電開始 (station_id, start_soc)`  
  → **走行**  
  → `放置終了 (parking_id, end_time, end_soc, duration)`
- 除外: 走行せず放置（別ソリューション対象）
- セクション単位で特徴量を生成（例: 放置時間, SOC開始/終了, 曜日, 時刻, station_id, parking_id）

---

## Step 2. Hashvin単位の指標作成
**影響度 (Impact)**
- `total_highsoc_hours` : 高SOC放置時間の総和
- `highsoc_ratio` : 高SOC放置時間 / 全放置時間
- `long_highsoc_share` : 長時間(≥12h)高SOC放置の割合
- `mid_highsoc_share` : 中時間(5〜8h)高SOC放置の割合

**分岐 (Diversity)**
- `branching_degree` : station→parkingの平均分岐数
- `branching_entropy` : 遷移多様性（必要に応じて）

**データ量**
- `n_sections` : セクション数
- `weeks_covered` : 観測週数
- `recency_coverage` : 直近利用率

**広がり**
- `n_stations` : 利用ステーション数
- `n_parkings` : 放置場所数
- `station_HHI`, `parking_HHI` : 集中度

---

## Step 3. 代表例層の選定方針
**主軸（必須4枠）**
1. 高SOC × 長時間（固定的な放置先）
2. 高SOC × 長時間（分岐多い）
3. 高SOC × 中時間（固定的）
4. 高SOC × 中時間（分岐多い）

**追加（2〜4枠）**
5. データ豊富（安定評価枠）
6. データ少（コールドスタート検証枠）
7. ステーション利用数が多いユーザー
8. 放置場所が多いユーザー

👉 合計 6〜8ユーザー程度をPoC代表例とする。

---

## Step 4. 選定手順（恣意性排除）
1. 全hashvinについて指標を算出
2. 分位点（Q1/Q3など）で二値ラベル化（例: long_highsoc_share ≥ Q3 → 長時間層）
3. 各層ごとに Impact スコアで順位付け
4. 層ごとに代表1名ずつ選出（主軸4枠は必ず確保）
5. 残り枠は追加層からImpactが高いユーザーを補充
6. 重複は主目的層に割当、他層は次点を繰り上げ

---

## Step 5. データ量対策
- 全量処理は非効率 → **まずはセクション化で圧縮**
- 全ユーザーについては軽量な集計（セクション単位集約）まで実施
- 精細前処理（5分粒度処理）は代表例ユーザーに限定
- 後続で全数展開する際は、集約済みテーブルから再利用可能にしておく

---

## Step 6. EDAで納得感を確認
- station×parkingヒートマップ：分岐の有無を可視化
- 高SOC放置時間の分布（箱ひげ/ヒスト）
- 曜日・時間帯の傾向
- 高SOC時間の時系列推移（季節性・最近性）

---

## Step 7. 評価設計
- **リーク防止**：hashvinごとの時系列ホールドアウト（最後の1〜2か月を外す）
- **精度指標**：MAE, RMSE（放置時点SOC, 放置時間）
- **業務KPI**：高SOC放置時間削減率（レコメンド介入シミュレーション）
- **再現性確認**：代表例での傾向を、同層の他ユーザーに横展開

---
