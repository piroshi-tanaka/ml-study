# 放置場所予測（候補生成＋二値スコア）

> 前提：**hashvin ごとに完全独立**で学習・評価する。  
> 目的：**充電完了直後**に発生する**最初の長時間放置（6h以上）**の放置クラスタを **Top-1** で当てる。  
> アプローチ：各充電セッションに対し、**候補クラスタを動的生成**し、**候補×セッション行**で **二値スコアリング（1=真／0=偽）**。セッション内で **確率最大**をTop-1として返す。  
> MVP特徴は **距離（m整数）／頻度／Recency／time_compat（中央値遅延×4hビン）**。＋αは **連続時間カーネルの遷移ヒント**のみ。  
> **新要件**：候補生成には**過去実際に放置したクラスタ**を必ず含める（**直近ウィンドウはhashvinごとに充電間隔へ適応**）。

---

## 0. ポリシー（重要）

1) **hashvin完全独立**  
   - 候補生成・統計（頻度／Recency／時間分布／遅延中央値／遷移辞書）・学習・評価の**全工程を単一hashvinのみ**で実施。  
   - 他hashvinのデータ・統計は一切使用しない。

2) **リーク防止**  
   - すべての統計（頻度・Recency・時間分布 `p_start`・遅延中央値 `L̃`・遷移辞書など）は **trainのみ**で作成し固定。  
   - valid/test／推論時は、**予測時点“まで”の履歴**で可変な値（例：Recency）は更新可、**固定辞書**は更新不可。  
   - 参照してよい時刻は **充電完了（ケーブル抜去）時点**まで。

3) **時系列Split（比率固定）**  
   - **train 0.7 / valid 0.1 / test 0.2**（`charge_end_time` 昇順）。  
   - 固定辞書は**trainで作成**。validはハイパラ・τ調整、testは最終評価。

4) **候補サイズ**  
   - 1セッションあたり候補数 **K’=5〜8** を目安（計算量・学習安定性・解釈性のバランス）。

5) **MVP＋α最小主義**  
   - MVP：`distance_m`（整数m）／`freq`／`recency_h`／`time_compat`。  
   - ＋α：`transition_prev_to_C`（**連続時間カーネル**による転移ヒント）のみ許可。  
   - フェーズ0/1（帰宅帯/出勤帯フラグ）は**不採用**（粗すぎる）。

---

## 1. 入力データ（前提）

### 1.1 入力①：イベント一覧（既存加工）
- `hashvin, session_cluster(-1はノイズ), session_type(inactive/charge), start_time, end_time, start_soc, end_soc, start_lat, start_lon, end_lat, end_lon, duration_minutes`  
- 20分未満の放置、充電後に移動せず放置、走行セッションは **除去済み**。

### 1.2 入力②：充電→最初の6h以上放置（既存加工）
- `hashvin`
- `charge_cluster, charge_start_time, charge_end_time, charge_start_soc, charge_end_soc, charge_lat, charge_lon, charge_durations_minutes`
- `next_long_inactive_cluster`（欠損なら教師対象外）
- `inactive_start_time, inactive_end_time, inactive_lat, inactive_lon, inactive_durations_minutes`

**教師対象**：`next_long_inactive_cluster` が **存在する充電セッション**のみ。

---

## 2. 候補生成（予測時にも同一ロジック）

**目的**：その時点で妥当な候補集合を動的に作り、**新規クラスタや動線変化**にも追随。  
**必須要件**：**過去実際に放置したクラスタ**を**直近ウィンドウ**から必ず含める（下記の適応ウィンドウ設計）。

### 2.1 適応ウィンドウ（hashvinごとの充電間隔に適応）
- **基本方針**：直近〇日を固定にせず、**充電間隔に比例**させて直近傾向を捉える。
- **推奨スキーム（学習・推論共通）**  
  1) **充電間隔の代表値**を算出：`Δcharge_med = 充電開始時刻の隣接差の中央値（日）`（trainで算出し固定）。  
  2) **ウィンドウ日数**：  
     - `win_days = clip( α * Δcharge_med , min_days , max_days )`  
       例：`α=6`，`min_days=7`，`max_days=56`  
     - 目的：**短い間隔の人は短期間の最新傾向**、**間隔が長い人は十分な観測量**を確保。  
  3) **代替（充電回数基準）**：直近 **R回の充電**（例：R=10）を常に最低限カバーし、`win_days` より古くてもR回分までは含める。  
  4) **最小実績数の確保**：直近ウィンドウで**長時間放置実績がM件未満**なら、`win_days` を段階的に拡張（例：×1.5）して**M件**（例：M=8）を満たすまで拡大（`max_days` 超えで停止）。

> これにより、**充電更新頻度の違い**（長い/短い）に自動適応しつつ、**直近傾向**を確実に取り込む。

### 2.2 候補の構成要素
1) **履歴候補（必須：直近ウィンドウ内の実績）**  
   - 適応ウィンドウ内の **6h以上の放置が実際に発生したクラスタ**を **Recency順**で上位抽出。  
   - **必ず候補に含める**（直近傾向の捕捉）。

2) **近接候補（空間）**  
   - 充電地点（`charge_lat, charge_lon`）からの**距離**で、半径 **r m** 内のクラスタを距離昇順で上位抽出。  
   - rは地域密度で可変（都市小／郊外大）。**近距離上位N**は下限確保。

3) **時間帯適合候補**  
   - §3の `time_compat_to_C` が高いクラスタの上位T件。

4) **統合＆クリップ**  
   - 集合和→重複除去→不足分を距離で補完→**K’=5〜8**にクリップ。  
   - **学習データ作成時**もこのロジックで候補を作り、**真のクラスタを必ず含める**（正例確保）。

---

## 3. 特徴量（候補×セッション行）｜MVP＋α

> 全特徴は**候補Cが未知でも計算可能**。予測は**充電完了時点**基準。

### 3.1 共通（セッション側）
- **曜日・時刻（完了基準）**：  
  - `dow = charge_end_time.weekday()`（0=Mon..6=Sun）  
  - `hour_sin, hour_cos = sin/cos(2π * hour_of_day / 24)`  
  **目的**：日／週周期の行動相（夜=HOME、平日昼=WORKなど）を滑らかに表現。

- **充電メタ**：  
  - `station_type`（200V/急速 One-Hot）、`soc_start, soc_end, soc_delta`、`charge_durations_minutes`  
  **目的**：充電の性質・SOC余力が次行動に与える影響。

### 3.2 候補依存（C：候補クラスタ）
1) **距離（メートル整数）** `distance_m`  
   - 計算：充電地点とC重心の**ハバーサイン距離[km] × 1000** を**四捨五入して整数m**。  
   - 必要性：**近接優位**は最強の先験。スケール解釈が明瞭。

2) **頻度** `freq_to_C`  
   - 計算：train内で **「充電直後6h放置としてCを選んだ回数」** の**累積**（薄い場合は**全6h放置回数**）。  
   - 推論時：**予測時点まで**の履歴で更新可（リーク禁止）。  
   - 必要性：**個体の習慣**の強さ。

3) **Recency（時間経過）** `recency_to_C_h`  
   - 計算：最後にCで6h以上放置してからの**経過時間[h]**。未訪問は大値（例：1e6）＋未訪問フラグ（0/1）を併用可。  
   - 必要性：**再訪周期**（最近よく行く場所が選ばれやすい）。

4) **時間相性（簡易）** `time_compat_to_C`（**中央値遅延 × 4hビン**）  
   - C側開始分布 `p_start_C[d,b]`：train内の**全6h放置開始**を `dow × 4h_bin（0–4,4–8,…,20–24）` の **42ビン**でカウント→ラプラス平滑で確率化。  
   - 遅延中央値 `L̃`：train内の**充電開始→長居開始**の遅延[h]の**中央値**（hashvin共通／十分ならC別）。  
   - 到着ビン：`charge_start_time` を `L̃` 前進（円環）→ `(d,b)` を決定。  
   - スコア：`time_compat_to_C = p_start_C[d,b]`（隣接ビン0.5加重で幅を許容可）。  
   - 必要性：HOME/WORKの**時間習慣**を遅延込みで反映（軽量・安定）。

5) **（＋α）連続時間カーネル遷移ヒント** `transition_prev_to_C`  
   - 狙い：**24hカテゴリではなく“時間の近さ”を連続的**に反映。  
   - 構成：train内の**直前長時間放置クラスタ `prev` → 次 `C`** の遷移サンプル集合。  
   - 重み付け：  
     - **円環時間カーネル**：`w_time = exp( - (Δt_circ)^2 / (2 σ_t^2) )`（`Δt_circ` は予測時刻とサンプル時刻の24h円環距離；推奨 `σ_t ≈ 2h`）  
     - **曜日近傍重み（任意）**：`w_dow`（同曜日=1、前後曜日=γ、その他=β）  
     - **prev一致重み（任意）**：`w_prev`（一致=1、不一致=λ）  
   - 確率化：`transition_prev_to_C ∝ Σ_s w_time × w_dow × w_prev` を候補Cで正規化（総和=1）。  
   - 必要性：HOME↔WORKなどの**日常ルート**を**時間の連続性**で滑らかに補助。

---

## 4. 学習用データフレーム（行増し）

- **行**：1充電セッション × そのセッションの**候補クラスタ K’件**  
- **カラム**：  
  - **キー**：`session_id, hashvin, charge_end_time, candidate_cluster`  
  - **共通特徴**：§3.1  
  - **候補依存特徴**：§3.2（`distance_m`, `freq_to_C`, `recency_to_C_h`, `time_compat_to_C`, `transition_prev_to_C`）  
  - **ラベル**：`label ∈ {1,0}`（真の `next_long_inactive_cluster` と `candidate_cluster` が一致なら1）  
- **注意**：候補集合に**真値を必ず含める**（適応ウィンドウ・近接・時間帯の各ルールの閾値を調整）。

---

## 5. 学習（二値スコア）

- **問題種別**：binary（1=真／0=偽）。  
- **目的**：候補行の「真である確率」を推定。  
- **データ**：hashvin内の **train 0.7**（valid 0.1 でハイパラ／τ調整）。  
- **負例バランス**：K’が小さいため特別な負例サンプリングは原則不要（必要ならクラス重み）。  
- **特徴量選別**：重要度を確認し、寄与の薄い列は削除（MVP維持）。

---

## 6. 推論フロー

1) **候補生成**（§2：適応ウィンドウ＋近接＋時間帯）  
2) **候補ごとに特徴算出**（§3）  
3) **二値モデルで確率推定**  
4) **セッション内argmaxでTop-1**  
5) **（任意）しきい値運用**：`max_prob < τ` は **推奨なし（NONE）**

---

## 7. 評価（セッション単位）

**必須**  
1) **Top-1 Accuracy（Strict）**：候補生成込みの実運用ビュー。  
2) **候補外真値率**：候補集合に真値が含まれなかった割合（候補生成の健全性指標）。  
3) **（参考）Head-like Accuracy**：真値が「trainで頻出したクラスタ」のみ抽出したビュー。  
4) **（任意）HOME/WORK相当のRecall**：概念タグ付与が可能なら取りこぼし確認。  
5) **（任意）Top-1@τ**：`Coverage@τ` / `Accuracy@τ`（誤推奨抑制用）。

---

## 8. 失敗モードと対策

- **候補漏れ**  
  - 対策：`win_days` の拡張（§2.1の最小実績Mを満たすまで）、半径rの動的拡張、近接バックアップN件の確保、時間帯上位T件の閾値緩和、最終手段「距離上位のみ」補完。

- **履歴希薄（新天地）**  
  - 対策：`distance_m` と `time_compat_to_C` の寄与で当てる設計。`recency`未訪問は大値＋未訪問フラグで明示。

- **時間帯ズレ（遅延変動）**  
  - 対策：`L̃` を曜日別に分ける／移動平均で安定化／隣接ビン0.5加重。

- **計算負荷**  
  - 対策：K’を5〜8に固定、候補統合後は距離でクリップ。特徴はMVP中心。

---

## 9. 運用（ドリフトに強い仕組み）

- **クラスタ在庫の更新**：DBSCAN等で**定期（週1〜月1）**にクラスタリング更新し**新規スポットを台帳追加**。  
  → モデル再学習なしで、候補生成が新クラスタを自動で拾う。

- **履歴辞書の更新**：推論時点までの履歴で **freq／Recency** は都度更新可。`p_start_C` と `L̃` は **train固定**（必要に応じて定期再学習）。  

- **監視**：`候補外真値率`、Top-1（Strict）、HOME/WORK相当のRecall、`transition_prev_to_C` の当たり方、`win_days` の自動調整結果を監視し、r・K’・σ_t・α・min/max_days・M をチューニング。

---

## 10. 設計判断の根拠（なぜ効くのか）

- **ID非依存**の特徴群（距離・履歴・時間統計）により、新規クラスタにも**モデル更新なしで一般化**。  
- **動的候補生成＋適応ウィンドウ**で、**直近傾向**を確実に取り込みつつ、充電頻度の個人差にも自動適応。  
- **distance_m × freq × recency × time_compat** の4本柱が、**物理制約・習慣・周期・遅延補正**を相互補完。  
- **連続時間カーネル遷移ヒント**で、24hカテゴリの粗さを回避し、**時間の“近さ”**を滑らかに反映。

