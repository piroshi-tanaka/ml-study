# EVバッテリ劣化抑制ソリューション アーキテクチャ検討レポート

## 1. はじめに

本ドキュメントは、機械学習を用いた「最適SOC誘導型バッテリ劣化抑制ソリューション」の実現に向けたアーキテクチャ設計の検討結果をまとめたものである。
本プロジェクトはPoC（概念実証）フェーズにあり、最終的な商用サービス化を見据えつつ、実現可能性、ビジネスインパクト、運用コストの観点から最適な推論配置（ECU vs クラウド）を決定する必要がある。

本レポートでは、一般的な技術特性の整理から始まり、本ソリューションにおける具体的な実装パターンの評価、そして最終構成を決定するための判断フレームワークを提示する。

---

## 2. 推論配置における技術特性の体系的整理

アーキテクチャ選定の基礎として、推論環境（クラウド vs エッジ/ECU）ごとの技術的特性を整理する。

<!-- | 観点 | クラウド推論 (Cloud Inference) | エッジ/ECU推論 (Edge Inference) | 参照ソース・根拠 |
| :--- | :--- | :--- | :--- |
| **計算資源** | **大・可変**<br>GPU等の強力なリソースを利用可能。需要に応じたスケーリングが容易である。 | **小・固定**<br>ECUのスペック（CPU/NPU/メモリ）に厳格に制限される。 | **[AWS SageMaker Docs](https://docs.aws.amazon.com/sagemaker/latest/dg/realtime-endpoints.html)**<br>クラウドの伸縮性とインスタンス選択の自由度について言及されている。 |
| **レイテンシ** | **中～大 (ネットワーク依存)**<br>通信往復時間(RTT)が発生する。電波状況に左右されるため変動幅が大きい。 | **極小 (リアルタイム)**<br>データ発生源で処理するため、ms単位の安定した応答が可能である。 | **[Synaptics Edge AI Blog](https://www.synaptics.com/company/blog/iot-edge-computing-ml)**<br>エッジコンピューティングがクラウドのレイテンシと帯域幅の課題を解決する点について解説されている。 |
| **可用性** | **通信依存**<br>トンネル、地下、山間部などの圏外や通信障害時は機能しない。 | **高 (スタンドアロン)**<br>通信環境に関わらず動作可能であるため、安全機能に適している。 | **[McKinsey Automotive Cloud/Edge](https://www.mckinsey.com/industries/semiconductors/our-insights/the-future-of-automotive-computing-cloud-and-edge)**<br>自動運転や安全機能など「停止が許されない機能」はエッジ必須であるとの論拠。 |
| **運用・更新** | **容易**<br>サーバー側のデプロイのみで全ユーザーに即時適用可能である。 | **困難・高コスト**<br>OTA (Over-The-Air) が必要となる。数万台規模への配布・検証・ロールバックの運用コストが高い。 | **[AWS IoT Greengrass Docs](https://docs.aws.amazon.com/greengrass/v2/developerguide/perform-machine-learning-inference.html)**<br>エッジへのモデル配布・管理（フリート管理）の複雑さと、それを解決する仕組みの必要性について記述されている。 |
| **プライバシ** | **データ転送必須**<br>位置情報等の生データを外部に出すためのセキュリティ設計および法令対応（GDPR等）が必要。 | **ローカル完結**<br>生データを出さず、推論結果のみを扱うことが可能である。 | **[Research: Edge vs Cloud](https://www.mdpi.com/2227-9709/11/4/71)**<br>プライバシ規制下においてエッジ処理がデータ保護の観点で有利である点について論じられている。 |
| **コスト** |従量課金となり、ユーザー数や利用頻度に比例してランニングコストが増加する | OTAによる配布コストなどは考えられるが、推論に必要なランニングコストは低い |  |
--- -->

### 2-1. 推論場所の特性 (Where)

| 比較項目 | クラウド推論 (Cloud Inference) | ECU推論 (Edge Inference) | 参照ソース・根拠 |
| :--- | :--- | :--- | :--- |
| **通信依存性** | **高 (常時接続前提)**<br>推論を実行するためには車両からのデータアップロードと結果のダウンロードが必須となる。トンネル、山間部、地下駐車場などの通信圏外では機能が停止するリスクがある。 | **低 (自律動作)**<br>推論プロセスが車両内部で完結するため、通信環境に一切依存せず機能提供が可能である。安定性が求められる機能に適している。 | **[AWS IoT Greengrass Docs]**<br>断続的接続下での機能維持について言及。 |
| **レイテンシ** | **中～大 (数百ms～数秒)**<br>純粋な計算時間に加え、モバイルネットワークの往復遅延（RTT）が発生する。電波状況によるジッタ（揺らぎ）が大きく、瞬時の判断には不向きである。 | **極小 (数ms～数十ms)**<br>データ発生源である車両内部で処理するため物理的な通信遅延がなく、ミリ秒単位の安定した応答が可能である。制御連動に有利。 | **[Synaptics Edge AI Blog]**<br>エッジの低遅延・広帯域活用の利点。 |
| **計算リソース** | **潤沢・可変**<br>GPUや大容量メモリインスタンスを柔軟に選択・拡張可能である。複雑な大規模モデルや、将来的なアルゴリズム変更にも対応しやすい。 | **限定的・固定**<br>車載SoCのスペック（メモリ、演算能力）に強く制約される。モデルの量子化や軽量化が必須となり、精度とのトレードオフが発生しやすい。 | **[AWS SageMaker Docs]**<br>クラウドのインスタンス多様性について。 |
| **コスト構造** | **OpEx (従量課金)**<br>リクエスト数やインスタンス稼働時間に応じた課金となる。利用が少ない時間はコストを下げられるため、スモールスタートに適している。 | **CapEx (固定費)**<br>高性能なチップやメモリの選定によるBOM（部品）コストの増加が全台数分発生する。一方で、運用時の通信費やクラウド利用料は抑制できる。 | **[McKinsey Automotive Cloud/Edge]**<br>車載コスト増とクラウドコストのトレードオフ。 |
| **運用・更新** | **容易**<br>サーバー側のデプロイのみで全ユーザーに即時適用可能である。 | **困難・高コスト**<br>OTA (Over-The-Air) が必要となる。数万台規模への配布・検証・ロールバックの運用コストが高い。 | **[AWS IoT Greengrass Docs](https://docs.aws.amazon.com/greengrass/v2/developerguide/perform-machine-learning-inference.html)**<br>エッジへのモデル配布・管理（フリート管理）の複雑さと、それを解決する仕組みの必要性について記述されている。 |

### 2-2. 推論手法の特性 (How)

クラウド、ECUそれぞれで選択可能な推論手法のマッピングと特徴。

| 推論手法 | 定義・特徴 | クラウド実装時の特性 (AWS想定) | ECU実装時の特性 |
| :--- | :--- | :--- | :--- |
| **リアルタイム推論**<br>(Real-time) | **即時応答型**<br>ユーザーのリクエストに対し、モデルが即座に結果を返す標準的なAPI形式。 | **[SageMaker Real-time Endpoint]**<br>常時インスタンスを起動しておく必要があり、待機時間（アイドルタイム）も含めてコストが発生するため割高になりやすい。 | **[Local Inference]**<br>モデルを常にメモリ上に展開し、アプリからの要求に即応する。他のアプリとのメモリ競合に注意が必要。 |
| **バッチ推論**<br>(Batch) | **一括処理型**<br>データを一定期間蓄積し、スケジュールされたタイミングでまとめて処理する。 | **[SageMaker Batch Transform]**<br>夜間などのオフピークに大量データを一括処理することで、単価の安いインスタンスを活用でき、最もコスト効率が良い。 | **[Micro-Batch]**<br>駐車中に「その車1台分」のデータを整理する程度であり、クラウドのような大規模並列処理によるスケールメリットは得にくい。 |
| **ストリーミング推論**<br>(Streaming) | **逐次処理型**<br>途切れることのないデータフローを監視し続け、リアルタイムに判定する。 | **[Kinesis + Lambda / Analytics]**<br>全車両から常時テレマティクスデータを送信し続ける必要があり、通信コストとデータ処理コストが膨大になるため現実的ではない。 | **[Sensor Loop Processing]**<br>CANやBMSからの信号を常時監視する。異常検知や危険回避など、ECUが得意とする基本的な処理形態である。 |
| **サーバーレス推論**<br>(Serverless) | **イベント駆動型**<br>リクエストがあった瞬間だけリソースを起動し、実行終了後に破棄する。 | **[SageMaker Serverless / Lambda]**<br>待機時間の課金がゼロであるため、頻度が低い機能に最適。ただし、起動時に「コールドスタート（数秒の遅延）」が発生する場合がある。 | **[Event-driven Component]**<br>イベント検知時のみプロセスを起動する。常時起動に比べてリソース消費を抑えられるが、即応性はリアルタイム型に劣る。 |

---

## 3. 推論配置パターンの定義
本プロジェクトで検討すべき推論配置パターンを以下の3つに定義し、それぞれの特徴を整理する。

| パターン名 | 概要 | 特徴・技術的詳細 | メリット・デメリット |
| :--- | :--- | :--- | :--- |
| **パターンA**<br>クラウド完結<br>(Cloud Only) | すべての推論（定期・突発・緊急）をクラウド上のAPIまたはバッチ処理で実行する。<br>車両はデータ収集と結果表示に徹する「シンクライアント」構成。 | **詳細**: SageMaker EndpointやBatch Transformを利用。車両からはHTTPS/MQTT等でリクエストを送信。<br>**適用**: 複雑な外部データ（天気、電力市場価格）を用いる処理や、計算負荷の高い最適化計算。 | **メリット**: モデル更新が容易（OTA不要）、初期BOMコスト抑制、高度な演算が可能。<br>**デメリット**: 通信圏外で機能停止、通信費・クラウド費の増大、レイテンシ大。 |
| **パターンB**<br>ECU完結<br>(Edge Only) | 学習済みモデルをECUへデプロイし、すべての推論を車載機内で実行する。<br>クラウドは学習とモデル配信のみを担当する。 | **詳細**: AWS IoT Greengrass等を用いてモデルを配信。推論エンジン（ONNX Runtime等）でローカル実行。<br>**適用**: 通信環境に依存できない安全機能や、ミリ秒単位の応答が必要な制御。 | **メリット**: 通信断でも動作、低レイテンシ、通信コスト削減、プライバシ保護。<br>**デメリット**: ECUリソース制約（精度とのトレードオフ）、モデル更新運用の複雑さ、BOMコスト増。 |
| **パターンC**<br>ハイブリッド機能分担<br>(Static Split) | 処理の性質に応じて「クラウド」と「ECU」を使い分ける。<br>・重い処理/全体最適 → クラウド<br>・即時処理/個別最適 → ECU | **詳細**: 定期的な充電計画はクラウドのバッチ処理で作成し、走行中の突発的な判断はECUで行う等の役割分担。<br>**適用**: 利便性と安全性の両立を目指す現実解。 | **メリット**: 両者の利点を享受（高機能かつ低遅延）。<br>**デメリット**: システム構成が複雑化し、開発・運用コストが二重にかかる（CloudとEmbedded両方のスキルセットが必要）。 |
<!-- 本ソリューションにおいて比較検討すべきアーキテクチャは、ハイブリッド（動的切り替え）ありきではなく、管理コストと特性の明確化のために以下の3パターンに集約される。

### パターンA：クラウド完結 (Cloud Only)
* **概要**: 学習・推論のすべてをクラウド（AWS SageMaker等）で行う。車両はセンサーデータを送信し、推論結果（推奨充電プラン）を受信するシンクライアント構成。
* **特徴**: モデル更新頻度が高い初期段階や、外部データ連携が必要な場合に有利。通信断時は機能しない。

### パターンB：ECU完結 (Edge Only)
* **概要**: クラウドで学習したモデルをECUへ配布し、推論は車両内で完結させる。
* **特徴**: 通信不要で常時動作し、レスポンスが高速。ただし、ECUリソース制限によりモデルサイズに制約があり、モデル更新の運用負荷が高い。

### パターンC：機能分担 (Static Split)
* **概要**: ユースケースごとに配置を固定する。
    * 重い処理（定期計画作成） → クラウド
    * 即応処理（緊急判定） → ECU
* **特徴**: 両者のメリットを享受できるが、「2つの推論環境の保守」「ロジックの不整合管理」という複雑さと二重コストが発生する。 -->

---

## 4. 推論トリガごとの評価マトリクス
想定される3つの主要トリガ（ユースケース）に対し、各パターンが適しているかを4つの基準で評価する。

**評価基準:**
* **精度**: 必要な情報（外部データ等）を用いて十分な予測精度が出せるか
* **運用コスト**: 通信費、クラウド利用料、ECUリソース単価のバランス
* **レイテンシ**: UXおよび安全性を満たす応答速度か
* **実装難易度**: 開発工数および運用フェーズでの保守性

| トリガ (Use Case) | 評価基準 (Criteria) | パターンA<br>クラウド完結 | パターンB<br>ECU完結 | パターンC<br>ハイブリッド | 評価の詳細・判断理由 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **① 習慣充電計画提案**<br>・朝一定期バッチ<br>・初回乗車時イベント | **精度** | **◎** (最適) | △ | **◎** | 明日の電力需給や広域の天気予報など、外部データを多用するためクラウド有利。ECU単体では情報不足になりがち。 |
| (いつ充電すべきか計画提案) | **運用コスト** | **◎** (安価) | ◯ | **◎** | 夜間にまとめてバッチ処理（SageMaker Batch Transform）することで、クラウドコストを劇的に圧縮可能。ECUをこの計算のために起動するのは電力浪費のリスクあり。 |
| | **レイテンシ** | ◯ | ◯ | ◯ | ユーザーが画面を見る前に計算済みであるため、推論時間はUXに影響しない。どのパターンでも許容範囲。 |
| | **実装難易度** | **◎** | △ | ◯ | クラウド側でのデータ結合が最も容易。ECU実装は外部データ取り込みの仕組みが複雑化する。 |
| **② 充電前イベント検知**<br>・充電プラグ接続検知<br>・エリア侵入検知 | **精度** | ◯ | ◯ | ◯ | 直近の車両状態（SOC、温度）が主入力となるため、どちらでも同等の精度が見込める。 |
| (今、充電すべきか即時判定) | **運用コスト** | △ | **◎** | ◯ | 頻度は中程度だが、クラウドの場合はAPI常時起動またはコールドスタート（Lambda）のコスト/遅延トレードオフが発生。ECUなら追加コストゼロ。 |
| | **レイテンシ** | △ (数秒) | **◎** (即時) | △ | アプリ経由の通知ならクラウド（数秒遅延）でも許容されるが、カーナビ画面での即時ポップアップならECUが体験として優れる。 |
| | **実装難易度** | ◯ | ◯ | △ | パターンCの場合、データ同期のロジックが必要となりやや複雑。 |
| **③ SOC低下検知**<br>・予測より低下<br>・下限割れ検知 | **精度** | △ | ◯ | ◯ | 瞬時の電流値や内部抵抗など、高頻度な車両内部データが必要なため、ECUで直接データを見る方が有利。 |
| (危険回避・安全側の提案) | **運用コスト** | × (高額) | **◎** (安価) | **◎** | 常時監視のために高頻度でデータをクラウドへ送ると、通信費とクラウド処理費が莫大になる。エッジ処理が圧倒的に有利。 |
| | **レイテンシ** | × (危険) | **◎** (安全) | **◎** | 安全に関わる警告は、通信遅延や圏外による不達が許されない。「止まってはいけない機能」はECU一択となる可能性が高い。**[McKinsey Report]** |
| | **実装難易度** | △ | △ | △ | どのパターンでもロジックは複雑だが、クラウド依存（A）は「通信断時のフェイルセーフ実装」が極めて困難。 |

---

## 4. 推論トリガごとの評価マトリクス

「推論手法」を主軸に、各ユースケースにおける3パターンの適合性を評価する。

**記号**: **◎**: 推奨 / **◯**: 適合 / **△**: 課題あり / **×**: 不適 / **－**: 該当なし

| 推論手法<br>(Method) | 対象ユースケース<br>(Use Case) | パターンA評価<br>(Cloud Implementation) | パターンB評価<br>(Edge Implementation) | パターンC評価<br>(Hybrid Implementation) | 評価理由・結論<br>(Reasoning) | 参照ソース<br>(Source) |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **バッチ推論**<br>(Batch Inference)<br><br>データを蓄積し、定時に一括処理する手法。 | **① 習慣充電計画提案**<br><br>・毎朝の推奨プラン作成<br>・週間スケジュールの更新 | **◎【採用（最適）】**<br><br>**[採用手法]** SageMaker Batch Transform<br>**[コスト]** ◎ (最安)<br>夜間の「スポットインスタンス」を利用し、全ユーザー分を一括計算することで、単価を極限まで圧縮可能。<br>**[レイテンシ]** ◯ (影響なし)<br>ユーザーが起床する前に計算が完了しているため、UX上の待ち時間はゼロである。<br>**[精度]** ◎ (最高)<br>「翌日の電力市場価格」や「広域天気予報」など、クラウド上の外部データを容易に結合でき、最も精度の高い計画が作成できる。 | **×【不採用（非効率）】**<br><br>**[採用手法]** Local Micro-Batch<br>**[コスト]** △ (バッテリ負荷)<br>駐車中に計算を行うためにはECUをウェイクアップさせる必要があり、暗電流による12Vバッテリ上がりのリスクがある。<br>**[レイテンシ]** ◯ (影響なし)<br>ローカル計算のため即時。<br>**[精度]** △ (情報不足)<br>ECU単体では、電力価格などの動的な外部情報を取得・同期する仕組みが複雑になり、最適化に必要な変数が不足する。 | **△【不採用（過剰）】**<br><br>**[採用手法]** Cloud Batch + Edge Logic<br>**[コスト]** △ (二重投資)<br>クラウドとECUの両方で実装・運用コストが発生する。<br>**[レイテンシ]** ◯<br>**[精度]** ◎<br>外部データ処理はクラウド、個人履歴はECUと分担可能だが、データ同期の複雑さに見合うメリットがない。 | **【結論：パターンA】**<br>コスト効率と精度の両面でクラウドバッチが圧倒的に有利である。<br>特に「外部データ（天気・電力）」との結合は、データが集約されているクラウド側で行うのがアーキテクチャとして自然であり、ECUにデータ配信するコストも削減できる。 | [SageMaker Batch Transform]<br>[AWS Architecture Blog] |
| **サーバーレス推論**<br>(Serverless)<br><br>リクエスト時のみ起動するイベント駆動型。 | **② 充電リマインド通知**<br>**③ アプリ経由の突発相談**<br><br>・頻度：低～中<br>・発生：不定期 | **◎【採用（コスト最適）】**<br><br>**[採用手法]** SageMaker Serverless / Lambda<br>**[コスト]** ◎ (安価)<br>1日数回程度の頻度であれば、待機時間の課金が発生しないサーバーレス構成が、常時起動サーバーより圧倒的に安い。<br>**[レイテンシ]** ◯ (許容範囲)<br>起動時に数秒の「コールドスタート」が発生するが、Push通知やアプリ操作であればUXとして許容される。<br>**[精度]** ◯ (十分)<br>クラウド上のデータを用いて十分な推論が可能。 | **－【区分対象外】**<br><br>**[採用手法]** -<br>**[コスト]** -<br>ECUには「サーバーレス（使った分だけ課金）」という概念が存在しない。<br>技術的にはイベントトリガでタスク起動可能だが、それはECUリソース内での処理（次項のリアルタイム推論）として評価すべきものである。 | **－【区分対象外】** | **【結論：パターンA】**<br>利用頻度が不定期かつ低頻度なユースケースにおいては、固定費を持たないクラウドサーバーレス構成がTCO（総保有コスト）の観点で最適解となる。<br>ECU実装もコストゼロだが、アプリ機能（スマホ側）との親和性を考えるとAPIベースのクラウド実装が合理的。 | [AWS Lambda Pricing]<br>[Serverless Inference Docs] |
| **リアルタイム推論**<br>(Real-time)<br><br>即時応答を返す同期処理。 | **④ 充電プラグ接続検知**<br>**⑤ エリア侵入時の提案**<br><br>・即時UXが必要<br>・カーナビ画面連携 | **×【不採用（高コスト）】**<br><br>**[採用手法]** SageMaker Real-time Endpoint<br>**[コスト]** × (高額)<br>いつ来るかわからないリクエストのためにAPIサーバーを常時稼働させる必要があり、費用対効果が悪い。<br>**[レイテンシ]** △ (不安定)<br>通信往復とクラウド処理で数秒のラグが発生し、カーナビの「サクサク感」を損なう。<br>**[精度]** ◯ (同等)<br>車両データのみで推論可能。 | **◎【採用（本命）】**<br><br>**[採用手法]** Local Inference (ONNX)<br>**[コスト]** ◎ (追加なし)<br>車両ハードウェアは購入済み（Sunk Cost）であるため、推論ごとの追加コストはゼロ。<br>**[レイテンシ]** ◎ (即時)<br>物理遅延がなく、プラグ接続と同時に結果を表示できる。<br>**[精度]** ◯ (同等)<br>直近の走行データから十分な推論が可能。 | **△【将来検討】**<br><br>**[採用手法]** Cloud Fallback<br>**[コスト]** × (最高額)<br>**[レイテンシ]** ◯<br>**[精度]** ◎<br>通常はクラウドの高精度推論を使い、遅延時はECUの簡易推論を出す構成。UXは良いが、PoC段階では実装コストが高すぎる。 | **【結論：パターンB】**<br>UX（即応性）とコスト（タダ乗り）の観点でECU実装が優れる。<br>特に「プラグを挿した瞬間」のような物理イベントに対するフィードバックは、通信遅延を含むクラウド経由では体験品質が著しく低下するため、ローカル処理が推奨される。 | [Synaptics Edge AI]<br>[User Experience Research] |
| **ストリーミング推論**<br>(Streaming)<br><br>常時データを監視する処理。 | **⑥ SOC低下検知・警告**<br><br>・走行中の常時監視<br>・安全機能(Safety) | **×【不採用（危険・高額）】**<br><br>**[採用手法]** Kinesis Data Streams<br>**[コスト]** × (破綻)<br>全車両のセンサーデータを秒単位で送信し続ける通信費は、事業収益を圧迫する。<br>**[レイテンシ]** × (危険)<br>通信遅延やパケットロスにより、警告が間に合わないリスクがある。<br>**[精度]** △ (間引き)<br>帯域制限のためデータを間引く必要があり、精細な解析ができない。 | **◎【採用（必須）】**<br><br>**[採用手法]** Sensor Loop Processing<br>**[コスト]** ◎ (通常動作)<br>ECUにおける通常のセンサー監視ループの一環として処理するため、追加コストは微小。<br>**[レイテンシ]** ◎ (確実)<br>異常発生からms単位での警告が可能。<br>**[精度]** ◎ (高解像度)<br>瞬時の電流値変化などの生データを直接監視できる。 | **◯【一部採用】**<br><br>**[採用手法]** Edge Filtering<br>**[コスト]** ◯<br>**[レイテンシ]** ◎<br>**[精度]** ◎<br>即時警告はECUで行い、異常時の詳細ログのみクラウドへ送る構成。実質的にはパターンBの拡張形である。 | **【結論：パターンB（必須）】**<br>安全に関わる機能（Safety）は、通信断のリスクを許容できないため、ECU内完結が必須要件となる。<br>また、常時通信によるコスト増大を避けるためにも、エッジコンピューティングによるデータ処理が不可欠である。 | [McKinsey Auto Report]<br>[ISO 26262 (Safety)] |
### 本プロジェクトにおける構成方針の結論

上記整理に基づき、本PoCおよび初期リリースにおいては、以下の**「適材適所のハイブリッド構成（論理設計）」**を前提とする。

1.  **ベースライン（基本機能）**:
    * 最も利用頻度が高く、計算負荷も高い「定期計画」は、**クラウド・バッチ推論 (A)** でコストを最小化する。
2.  **インタラクション（ユーザー接点）**:
    * ユーザーへの能動的な働きかけ（リマインド等）は、**クラウド・サーバーレス推論 (B)** で安価に実現する。
3.  **セーフティ＆リアルタイム（車載機能）**:
    * 即時性が求められる警告や、通信断リスクを排除すべき機能は、**ECU・リアルタイム推論 (D)** に配置する。
    * *※ただし、PoC初期段階では開発効率を優先し、(D)の領域も一時的に(C)のクラウドAPIで代替検証するアプローチを許容する。*
<!-- 各ユースケース（トリガ）に対し、3つのパターンを5つの基準で評価した。

**評価凡例**: ◎: 最適 / ◯: 適合 / △: 課題あり / ×: 不向き

| トリガ (Use Case) | 評価基準 (Criteria) | パターンA<br>クラウド完結 | パターンB<br>ECU完結 | パターンC<br>機能分担 | 評価・判断理由の詳細 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **① 定期リコメンド**<br>(翌日の充電計画) | **精度・情報量**<br>(外部データ連携) | **◎** | △ | **◎** | **A/C有利**: 翌日の計画には「天気予報」「電力需給」「他ユーザーの傾向」など、クラウド上の最新情報が必須である。ECU単独ではこれらの動的な外部情報をリアルタイムに取り込む仕組みが複雑化するため、クラウド処理が合理的である。 |
| | **運用コスト**<br>(通信・計算) | **◎** | ◯ | **◎** | **A/C有利**: 夜間に「Batch Transform」等でまとめて計算することで、クラウドコストを最小化できる。ECUの場合、計算のために個々の車両を起動する必要があり、暗電流や電力消費の観点で非効率となる可能性がある。 |
| **② 突発リコメンド**<br>(直前の充電可否) | **即時性**<br>(レイテンシ) | ◯ | **◎** | ◯ | **B有利**: ECUはmsオーダーで応答可能である。一方、クラウドは通信往復を含め数秒かかるが、人間がアプリを操作して結果を待つユースケース（数秒の待機は許容される）であれば、A/Cでも実用上の問題はない。 |
| | **可用性**<br>(通信断時の動作) | △ | **◎** | △ | **B有利**: 地下駐車場などで通信が繋がらない場合、AおよびC（クラウド側機能）は動作しない。ここを「仕様（圏外では利用不可）」とするか、「必須要件」とするかがアーキテクチャ決定の分かれ目となる。 |
| **③ 緊急判定**<br>(SOC下限/乖離) | **即時性・安全性**<br>(レイテンシ) | △ | **◎** | **◎** | **B/C有利**: 走行中のSOC急減などの緊急判定は、通信遅延や切断が命取りとなる。即座にドライバーへ警告する必要があるため、ECU側での処理が強く推奨される（あるいは必須要件となる可能性が高い）。 |
| | **実装難易度**<br>(開発・更新) | ◯ | △ | △ | **A有利**: ECUへのモデル実装は、メモリ制約への適合（量子化・軽量化）や、OTAによる更新運用など、開発・保守コストが増大する。Cは両方の環境を管理が必要なため、最も管理コストが高い。 | -->

---

## 5. 最終構成決定のための判断フレームワーク

PoCを通じて以下の「未確定パラメータ」を埋めることで、論理的に最終構成を決定する。

### 5-1. 調査・決定すべき項目リスト（Decision Parameters）

以下の項目をPoCにて数値化・言語化する。

1.  **許容レイテンシの定義 (UX要件)**
    * トリガ②（充電前リコメンド）において、ユーザーが許容できる待ち時間は何秒か？
    * *目安: 1秒未満ならECU必須、3秒以上ならクラウドAPI可。*
2.  **オフライン動作要件 (可用性要件)**
    * 地下駐車場や山間部（通信圏外）でのリコメンド機能は必須か、それとも「通信不可のため利用できません」で許容されるか？
    * *必須ならパターンB/C（ECU実装）が確定。*
3.  **SOC低下検知の責任分界 (安全性要件)**
    * この機能は「ユーザーへの親切なアドバイス」か、それとも「電欠防止の安全機能（Safety）」か？
    * *安全機能ならECU実装が必須。*
4.  **ECUリソースの実行可能性 (Feasibility)**
    * 対象ECUにおいて、想定モデル（ONNX等）のメモリ使用量と推論時間は許容範囲内か？
    * *リソース不足ならクラウド一択。*
5.  **コスト分岐点の試算 (Cost Balance)**
    * 「月間通信費＋API利用料」と「ECU単価増＋開発費償却分」の分岐点はどこか？
    * *ユーザー数や推論頻度のパラメータをPoCで収集して試算。*
<!-- 
| 分類 | No. | 検討項目 | 調査・決定すべき問い (Question) | 判定への影響 |
| :--- | :--- | :--- | :--- | :--- |
| **要件** | **Q1** | **許容レイテンシ** | ユーザーは操作後、結果表示まで何秒待てるか？（例：3.0秒） | 1秒未満ならECU必須。3秒以上ならクラウドAPIで可。 |
| **要件** | **Q2** | **オフライン要件** | 圏外での機能不全を許容するか？ | 許容不可ならECU必須。許容ならクラウドでOK。 |
| **要件** | **Q3** | **安全機能の範囲** | SOC下限警告は本AIの責務か、既存BMSの責務か？ | AIが安全責務ならECU必須。助言レベルならクラウド可。 |
| **技術** | **T1** | **モデルサイズ** | ONNX化・量子化後のサイズはECU容量に収まるか？ | 容量超過ならクラウド一択。 |
| **技術** | **T2** | **推論速度(ECU)** | 想定ECUでの推論時間は許容範囲内か？ | 処理落ちするならクラウド一択。 |
| **技術** | **T3** | **通信遅延(RTT)** | 実走行環境（4G/5G）での平均/99%タイル遅延は？ | Q1を満たせなければECU必須。 | -->



---

## 6. PoCおよび今後のアクションプラン

上記検討を踏まえ、本プロジェクトでは以下のステップで進行する。

### 方針概要
* **PoCフェーズ**: 原則として**「パターンA（クラウド完結）」**を採用する。
    * **理由**: モデルのアルゴリズム改善（精度向上）こそが最大の不確実性であり、デプロイサイクルの速いクラウドでこれを最優先に検証するため。
* **並行検証**: 将来のリスクヘッジとして、ECU実装の技術的実現性（Feasibility）のみ並行して確認を行う。

### 具体的なアクション
1.  **ビジネス要件の仮定義 (Q1〜Q3)**
    * 特に「オフライン時の挙動」と「安全機能の責任分界点」について、事業部および車両開発側と合意形成を図る。
2.  **クラウドベースでのモデル検証 (パターンA)**
    * SageMakerを用いたパイプライン構築。
    * バッチ推論によるコスト試算および精度検証。
3.  **ECU実装性の机上・実機検証 (T1, T2)**
    * 作成したモデルをONNX形式へ変換し、量子化によるサイズ圧縮率と精度劣化を測定する。
    * 開発用ボード等で推論速度をベンチマークし、ECU搭載の可否を判断する材料を揃える。
  
### 6-2. 具体的なアクションアイテム

1.  **UX・非機能要件の定義完了**
    * 事業部門と協議し、「オフライン時の挙動」「許容レイテンシ」のSLA（Service Level Agreement）案を作成する。
2.  **クラウド環境でのモデル性能・コスト計測**
    * SageMakerを用いたパイプラインを構築し、実際のデータを用いた予測精度（MAE/RMSE）と、リクエストあたりのAWSコストを計測する。
3.  **ECU実装フィジビリティスタディ**
    * 学習済みモデルをONNX形式に変換および量子化し、ターゲットECU（または同等スペックの開発ボード）での推論時間とメモリ使用量を実測する。
4.  **通信環境調査**
    * 実車またはテスト走行により、ターゲットエリアにおけるLTE/5Gの遅延分布（RTT）と圏外率を測定し、クラウド推論時のUXリスクを定量化する。

## 7. 参考文献

1.  **Amazon SageMaker リアルタイム推論** (https://docs.aws.amazon.com/sagemaker/latest/dg/realtime-endpoints.html)
2.  **Synaptics: IoT Edge Computing & ML** (https://www.synaptics.com/company/blog/iot-edge-computing-ml)
3.  **McKinsey: The future of automotive computing** (https://www.mckinsey.com/industries/semiconductors/our-insights/the-future-of-automotive-computing-cloud-and-edge)
4.  **AWS IoT Greengrass: Perform ML Inference** (https://docs.aws.amazon.com/greengrass/v2/developerguide/perform-machine-learning-inference.html)
5.  **MDPI: Cloud vs Edge Computing** (https://www.mdpi.com/2227-9709/11/4/71)

以上


