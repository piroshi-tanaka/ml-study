# EVバッテリ劣化抑制ソリューション  
次々回充電タイミングベース・リコメンドアルゴリズム設計書（最終版）

---

## 1. ソリューション概要（テキスト仕様）

### 1.1 目的

ユーザーごとの「普段の充電習慣」を学習し、以下をリコメンドするアルゴリズムを設計する。

- 「今回の充電をスキップしてよいか？」
- 「緊急時にどれだけ充電すべきか？」

コアとなるロジックは次の通り。

- 次回・次々回の「通常充電タイミング」を予測する
- 今充電しない場合に、次回・次々回までにどれだけ SOC が減少するかを予測する
- 以下の条件で意思決定する  
  - 「現在SOC − 次々回までの消費SOC ≥ SOC下限」なら、**今回スキップ可**  
  - 満たさない場合は、**どのタイミングで、どれくらい充電すべきか**をリコメンド

これにより、

- 不要な高SOC放置・過剰充電を減らし、
- SOC切れリスクを抑えつつ、
- 通常の充電習慣に極力沿ったかたちでユーザー行動を支援する。

---

### 1.2 内部モード（状態）の構成

アルゴリズム内部では、以下のモード（状態）を持つ。

- `NORMAL`  
  - 通常の習慣（曜日・時間帯・場所・SOC/閾値）に基づいて充電タイミングを予測し、
    スキップ可否を判定する標準状態。
  - 例：
    - 金曜夜自宅での定例充電
    - 毎晩のライフサイクル充電
    - 残量 X% を下回りそうなときに充電する「SOC閾値ベースの充電習慣」

- `TRAVEL`（旅行・イレギュラーモード）  
  - 長距離走行、未知クラスタ滞在など、普段と異なるパターンが検知された状態。
  - スキップリコメンドを抑制／停止し、「減ったら充電」寄りの安全挙動を優先。

- `EMERGENCY_BEFORE_NORMAL`（緊急：通常充電前の残量不足）  
  - 本来の次回充電タイミングより前に、SOCが危険域に近づいた状態。
  - 不足回避を最優先に、推奨充電量を計算する。
    - 方針A：次回の通常充電タイミングまで持たせる
    - 方針B：次々回の通常充電タイミングまで持たせる

- `OPPORTUNISTIC_CHARGE`（突発・たまたま充電）  
  - 普段充電しない曜日・時間・場所、かつ緊急ではないが、ユーザーがたまたま充電した状態。
  - 今回の充電タイミングは「今」に固定し、
    - 「どれくらい充電するか」を最適化
    - 習慣モデルを壊さないよう、学習は低い重みで扱う（単発ノイズとして処理）

- `COLD_START`（概念的：データ不足）  
  - ※状態遷移図では明示的な状態ノードにはせず、`NORMAL` 内部の「ポリシーフラグ」として扱う想定。
  - ユーザー個別データが足りない状態。  
  - 共通モデル／ルールベース中心で、安全側に運用（スキップほぼ禁止）。

---

### 1.3 推論・リコメンドのタイミング（トリガー）

- 通常系（`NORMAL`）：
  - 朝一のバッチ推論
    - 例：1〜数日先の充電パターン・スキップ可否の計算
  - 車両起動時／アプリ起動時の再評価

- イレギュラー／イベント系（`EMERGENCY_BEFORE_NORMAL`, `OPPORTUNISTIC_CHARGE`, `TRAVEL`）：
  - 充電ケーブル接続イベント
    - 充電開始前に即時計算
  - SOC が安全閾値を下回りそうなときの車両側イベント
  - アプリからのオンデマンド要求：
    - 「今から充電するけど、次回・次々回の充電タイミングまでを考慮したおすすめ充電量を教えて」ボタン

---

### 1.4 安全・復帰・ユーザー優先のインバリアント

復帰ロジックおよび全体アルゴリズムは、次の 3 つのインバリアントを常に満たすよう設計する。

1. **安全側インバリアント**
   - SOC下限を割るリスクが高い場合は、必ず「充電推奨」側に倒れる。
   - 旅行・データ不足・予測外の急減など、不確実性が高い状況では、
     スキップリコメンドを抑制し、安全寄りの充電プランのみ提示する。

2. **習慣復帰インバリアント**
   - 旅行・緊急・突発充電があっても、  
     一定期間、従来どおりのパターンが続けば `NORMAL` に復帰する。
   - 単発のイレギュラーで習慣モデルを壊さず、同じイレギュラーが繰り返される場合のみ、
     新しい習慣として徐々に取り込む。

3. **ユーザー優先インバリアント**
   - ユーザー行動（リコメンド無視）は常に優先される。
   - アルゴリズムはあくまで「提案」であり、
     推奨内容・実行された行動・差分をログに残し、次回以降の学習に活かす。

---
