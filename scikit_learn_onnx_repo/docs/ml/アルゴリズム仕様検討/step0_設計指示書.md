# EVバッテリ劣化抑制ソリューション：アルゴリズム設計・評価用インデックス

このドキュメントは、次のチャット以降で作成する設計書（UML図・マトリクス・Fail-Safe設計）の「前提・指示書」として利用する。

---

## 1. ソリューション全体構成（アルゴリズム視点の整理）

### 1-1. ソリューションの目的

- ユーザーごとの「普段の充電習慣」を学習し、
  - 「今回の充電をスキップしてよいか？」
  - 「緊急時にどれだけ充電すべきか？」
を判断・リコメンドする。

- コアとなるロジック：
  - 次回・次々回の「通常充電タイミング」を予測
  - 今充電しない場合に、次回・次々回までにどれだけ SOC が減少するかを予測
  - 安全マージンを満たすなら「今回スキップ可」、満たさないなら「充電量をリコメンド」

### 1-2. 内部モード（状態）の構成

アルゴリズム内部は、少なくとも以下のモードを持つ想定とする。

- `NORMAL`  
  - 通常の習慣（曜日・時間帯・場所・SOC）に基づいて充電タイミングを予測し、  
    スキップ可否を判定する標準状態。

- `TRAVEL`（旅行・イレギュラーモード）  
  - 長距離走行、未知クラスタ滞在など、普段と異なるパターンが検知された状態。
  - スキップリコメンドを抑制／停止し、安全側の挙動を優先。

- `EMERGENCY_BEFORE_NORMAL`（緊急：通常充電前の残量不足）  
  - 本来の次回充電タイミングより前に、SOCが危険域に近づいた状態。
  - 「とりあえず今充電しないと危ない」状態として、推奨充電量を計算。
    - 方針A：次回の通常充電タイミングまで持たせる
    - 方針B：次々回の通常充電タイミングまで持たせる

- `OPPORTUNISTIC_CHARGE`（突発・たまたま充電）  
  - 普段充電しない曜日・時間・場所、かつ緊急ではないが、ユーザーがたまたま充電した状態。
  - 習慣モデルを壊さないよう、学習時の重みを小さめに扱う。

- `COLD_START`（任意：データ不足）  
  - ユーザー個別データが足りない状態。
  - 共通モデル／ルールベース中心で、安全側に運用する。

### 1-3. 推論・リコメンドのタイミング（トリガー）

- 通常系（`NORMAL`）：
  - 朝一のバッチ推論（例：1日〜数日先の充電パターン・スキップ可否の計算）
  - 車両起動時／アプリ起動時の再評価

- イレギュラー／イベント系（`EMERGENCY_BEFORE_NORMAL`, `OPPORTUNISTIC_CHARGE`, `TRAVEL`）：
  - 充電ケーブル接続イベント（充電開始前に即時計算）
  - SOC が安全閾値を下回りそうなとき（車両側イベント）
  - アプリからのオンデマンド要求：
    - 「今から充電するけど、次回・次々回の充電タイミングまでを考慮したおすすめ充電量を教えて」ボタン

---

## 2. 主要ユースケースの説明

次チャット以降で UML（ユースケース図・アクティビティ図・状態遷移図）を作るため、  
ここではテキストでユースケースを整理しておく。

### 2-1. 通常系ユースケース

1. **習慣どおりの金曜夜自宅充電（NORMAL）**
   - パターン：
     - 毎週金曜夜に自宅で充電するユーザー。
   - アルゴリズムの役割：
     - 朝一バッチで「次回=金曜」「次々回=火曜」などを予測。
     - 現在SOC・利用予定から、金曜スキップの可否を判定し、スキップ可能ならリコメンド。

2. **毎日夜間自宅で充電（ライフサイクル充電）**
   - パターン：
     - 平日は毎晩自宅で充電する。
   - アルゴリズムの役割：
     - 次回＝今晩、次々回＝明晩として SOC 消費を予測。
     - 「今晩スキップしても明晩まで持つか？」を判定し、スキップ可否をリコメンド。

### 2-2. イレギュラー系ユースケース

3. **木曜に突発 40% 充電 → 金曜スキップ判定（OPPORTUNISTIC_CHARGE）**
   - パターン：
     - 通常は金曜夜に充電するユーザーが、木曜夜にたまたま 40% で充電。
   - アルゴリズムの役割：
     - 木曜の充電開始イベント時にオンデマンド推論。
     - `OPPORTUNISTIC_CHARGE` と判定し、  
       木曜時点 SOC・走行パターンから「金曜・火曜までの SOC 安全性」を再計算。
     - 安全なら「金曜スキップ可」をリコメンド。
     - 学習ではこの木曜充電を「単発の例外」として重み小さめに扱い、  
       習慣モデルを崩しすぎない。

4. **金曜まで持つはずが、木曜に SOC 不足（EMERGENCY_BEFORE_NORMAL）**
   - パターン：
     - 通常は金曜まで持つはずだったが、想定以上の走行で木曜の時点で 0% 近くになる。
   - アルゴリズムの役割：
     - SOC が予測より急減 → `EMERGENCY_BEFORE_NORMAL` に遷移。
     - 「次回（金曜）」または「次々回（火曜）」まで持たせるための充電量を計算。
     - 緊急モード用の方針（A：次回まで / B：次々回まで）に従ってリコメンド。

5. **旅行（TRAVEL）**
   - パターン：
     - 直近 1〜3 日で総走行距離が平常の数倍、未知クラスタへの長距離移動。
   - アルゴリズムの役割：
     - 「旅行モード」を検知し、`TRAVEL` に遷移。
     - この期間中はスキップリコメンドを抑制／停止し、「減ったら充電」寄りの安全挙動。
     - 自宅クラスタで一定時間駐車などの条件で `NORMAL` に復帰。

6. **旅行中のサービスエリア充電（TRAVEL + OPPORTUNISTIC）**
   - パターン：
     - 旅行中、高速道路の SA で数回充電。
   - アルゴリズムの役割：
     - `TRAVEL` 状態のまま `OPPORTUNISTIC_CHARGE` 的に扱う。
     - 習慣に組み込まない前提で、ノイズとして処理。

7. **リコメンド無視で充電するケース**
   - パターン：
     - 「スキップ推奨」だったが不安なので充電する／逆に「充電推奨」を無視する。
   - アルゴリズムの役割：
     - ユーザー行動を常に優先（アルゴリズムが負ける）。
     - 充電開始イベントを起点として、SOC予測を再計算。
     - ログ上は「推奨内容」「実行された行動」「差分」を記録し、次回学習の特徴量として利用。

8. **新規ユーザで十分なデータがない（COLD_START）**
   - パターン：
     - 充電履歴・走行履歴が少なく、個人習慣がまだ見えない。
   - アルゴリズムの役割：
     - 共通モデル／ルールベースによる保守的な運用。
     - 一定データが貯まるまでは、スキップの判断を控える／閾値を厳しめにする。

---

## 3. 設計書の構成と次チャットでやること

このプロジェクトで残す設計書は、少なくとも以下の 5 つの要素で構成する。

1. **ユースケース図**
   - 目的：
     - 本ソリューションが対象とする「ユーザー行動」と「システム機能」の範囲を明示する。
   - 含める内容：
     - 通常充電・突発充電・緊急充電・リコメンド無視・オンデマンド問い合わせ、など。
   - 表現：
     - PlantUML の `usecase` を用いて作成。

2. **アクティビティ図**
   - 目的：
     - 「データ取得 → モード判定 → 予測 → 判定 → リコメンド → ユーザー行動」までのフローを可視化する。
   - 重要ポイント：
     - 「ユーザーがリコメンドを無視した」分岐。
     - 「リコメンドに従ったが予定外の長距離移動が発生した」分岐。
     - イベント駆動（緊急・突発）と朝一バッチの違い。

3. **状態遷移図**
   - 目的：
     - `NORMAL` / `TRAVEL` / `EMERGENCY_BEFORE_NORMAL` / `OPPORTUNISTIC_CHARGE` / `COLD_START` 間の遷移と復帰条件を明確にする。
   - 重要ポイント：
     - イレギュラー（旅行・緊急）が発生した後、どうやって「普段の習慣」に戻るか。
     - どの状態でも安全側のインバリアント（Fail-Safe）が守られること。

4. **マトリクスを用いたシナリオトレース（シナリオ・レスポンス・マトリクス）**
   - 目的：
     - 代表ユースケースを行に、状態/アルゴリズム挙動/ユーザー反応/次状態/判定を列に持つマトリクスで、  
       「アルゴリズムが破綻していないか」を体系的に確認する。
   - 例：
     - ユースケース、現在の状態、アルゴリズムの挙動、ユーザーの反応、次の状態、OK/NG。

5. **復帰ロジック（Fail-Safe）の設計**
   - 目的：
     - イレギュラー（旅行・予測外・ユーザーの予期せぬ行動）から、  
       「安全側で」かつ「元の習慣ベースに自然に戻る」仕組みを定義する。
   - 主要トリガー：
     - イベントトリガー（満充電・自宅帰着・夜間長時間駐車など）
     - 不確実性トリガー（モデルの自信が低い → リコメンド一時停止）

---

## 4. 次のチャットへの指示書

次チャット以降で、段階的に設計書を仕上げていくための指示をまとめる。

### 4-1. 次チャット（チャットA）でやりたいこと

**テーマ：ユースケース図＋高レベルアクティビティ図の作成**

1. ユースケース図
   - ここで整理した 2. のユースケース説明をもとに、
   - PlantUML でユースケース図を作成するよう依頼する。
   - 要件：
     - アクター：ユーザー / 車両・車載システム / モバイルアプリ
     - ユースケース：
       - 通常充電リコメンド
       - 旅行中の安全リコメンド
       - 緊急充電量リコメンド
       - 突発充電サポート
       - リコメンド無視時の挙動
       - オンデマンド「今から充電」問い合わせ

2. 高レベルアクティビティ図
   - 「データ取得 → モード判定 → 予測 → 判定 → リコメンド → ユーザー行動 → ログ記録 →（必要に応じて再学習）」までのフローを、PlantUML でアクティビティ図として描いてもらう。
   - 上記ユースケースのうち、特に以下の分岐を含めるよう指示：
     - リコメンドに従う場合／無視する場合
     - 突発充電が起きた場合
     - 旅行モードと判定された場合

### 4-2. チャットB 以降でやりたいこと（ざっくり）

- チャットB：状態遷移図（モード遷移＋復帰条件）の詳細化
  - `NORMAL` / `TRAVEL` / `EMERGENCY_BEFORE_NORMAL` / `OPPORTUNISTIC_CHARGE` / `COLD_START`
  - 検知条件・復帰条件を PlantUML で記述。

- チャットC：シナリオ・レスポンス・マトリクスの作成
  - 代表ユースケース（2章）を行に、
  - State / Action / User Reaction / Next State / 判定 を列にした表を整備。

- チャットD：Fail-Safe／復帰ロジックの明文化
  - イベントトリガー（満充電、自宅帰着、夜間駐車）と不確実性トリガー（予測区間の広さなど）を、  
    インバリアントとともに設計文書に落とす。

---

## 5. 次チャットで ChatGPT に投げる想定プロンプト例（メモ）

> 「前回まとめた『EV充電リコメンドソリューション』の設計方針を前提として、  
>  主要ユースケース（NORMAL / TRAVEL / EMERGENCY / OPPORTUNISTIC / COLD_START）を含んだ  
>  ユースケース図と、高レベルのアクティビティ図（データ取得→モード判定→予測→判定→リコメンド→ユーザー行動）を  
>  PlantUML で作成してください。  
>  特に、リコメンド無視・突発充電・旅行モードの分岐を必ず図に含めてください。」

このドキュメントを前提としておけば、  
次チャットからはそのまま「設計書の各要素（図・マトリクス・Fail-Safe）」を具体化していくことができる。
