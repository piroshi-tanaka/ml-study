## 1. 前提整理（今回やること）

- 状態遷移図：前回作成した `NORMAL / TRAVEL / EMERGENCY_BEFORE_NORMAL / OPPORTUNISTIC_CHARGE` のまま採用（COLD_STARTは状態外で扱う）。
- 今回追加するもの：
  1. **通常系ユースケースに「SOC閾値ベース充電」を追加したシナリオ・レスポンス・マトリクス**
  2. **状態 × トリガー → アクティビティ図ブロック対応マトリクス**

---

## 2. シナリオ・レスポンス・マトリクス

### 2-1. 通常系ユースケース（曜日/時間帯・ライフサイクル・SOC閾値）


| ID | ユースケース                                           | 現在状態  | トリガー                          | アルゴリズムの主な挙動                                                                                                              | ユーザーの典型的反応                                            | 次状態  | 判定        |
|----|--------------------------------------------------------|-----------|-----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|---------|-------------|
| N1 | 習慣どおりの金曜夜自宅充電（曜日・時間帯ベース）       | NORMAL    | 朝一バッチ（平日朝）             | アクティビティ図の「トリガー判定: NORMAL」→ 共通フロー（CaseA/B/C）。多くは CaseA or B。次々回まで到達可なら「金曜スキップ＋次々回充電プラン」を生成。 | 「スキップ可」であれば、金曜をスキップするパターンが多い想定    | NORMAL  | OK          |
| N2 | 毎日夜間自宅で充電（ライフサイクル充電）               | NORMAL    | 朝一バッチ（毎朝）               | 同上。翌日・翌々日を次回/次々回として CaseA/B/C 判定。CaseA なら「今晩スキップ＋明晩充電」、CaseB なら「今晩充電必須」プランを提示。                 | スキップ提案に対し、不安であれば無視して今晩も充電することもある | NORMAL  | OK（無視時もログで吸収） |
| N3 | SOC閾値ベースの通常充電（残量X％以下で充電する習慣）   | NORMAL    | 朝一バッチ＋SOC低下の通常イベント | 「トリガー判定: NORMAL」→ 共通フロー。ユーザーの履歴から「SOCがX％付近になった後、どこで充電するか」が学習されており、そのパターンを前提に次回/次々回を予測。SOCが閾値に近づいていれば CaseB/C 寄りとなり「近い将来の充電必須プラン」を生成。 | ユーザーは「いつものSOCレベルになったら充電する」感覚で行動。推奨タイミング・量がその習慣と大きく乖離しなければ採用されやすい。 | NORMAL  | OK（SOC閾値もNORMAL習慣の一部として吸収） |


### 2-2. イレギュラー系ユースケース
| ID  | ユースケース                                           | 現在状態           | トリガー                                   | アルゴリズムの主な挙動                                                                                                                                              | ユーザーの典型的反応                                                | 次状態                               | 判定                         |
|-----|--------------------------------------------------------|--------------------|--------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------|--------------------------------------|------------------------------|
| E1  | 木曜に突発40%充電 → 金曜スキップ判定                  | NORMAL             | 木曜夜の充電開始イベント or 今から充電    | トリガー判定で OPPORTUNISTIC_CHARGE を選択 → 共通フロー（CaseA/B/C）。多くは CaseA/B。CaseAなら「今回充電不要 or 最小限」「金曜スキップ＋火曜充電」等の複数プランを提示。 | 突発機会なので、少しは充電したいユーザーも多く、最小限充電案を選ぶ傾向 | OPPORTUNISTIC_CHARGE → NORMAL        | OK（習慣はNORMAL側で維持）   |
| E2  | 金曜まで持つはずが木曜にSOC不足（EMERGENCY_BEFORE_NORMAL） | NORMAL or TRAVEL   | 木曜時点のSOC低下イベント                 | トリガー判定で EMERGENCY_BEFORE_NORMAL → 共通フローの CaseB/C ルート。候補時刻ごとに「次回まで」「次々回まで」など複数プランを算出し、不足しないプランを最優先でおすすめ。 | 多くは「不足リスク最小」の緊急寄りプランを選択                     | EMERGENCY_BEFORE_NORMAL → NORMAL/ TRAVEL | OK（不足回避を最優先）      |
| E3  | 旅行（TRAVEL：長距離/未知クラスタ）                  | NORMAL → TRAVEL    | 長距離走行/未知クラスタ滞在の連続検知     | 状態遷移図上で TRAVEL に遷移。アクティビティ図は共通フローを使うが、モード別ポリシーでスキップ抑制・安全側プランを優先。旅行中は「減ったら充電」寄りに shift。       | サービスエリア等での複数回充電を行う。リコメンドは参考程度に利用     | TRAVEL                               | OK（Fail-Safe 優先）         |
| E4  | 旅行中のサービスエリア充電（TRAVEL + OPPORTUNISTIC） | TRAVEL             | 旅行中の充電開始イベント                  | TRAVEL 状態から OPPORTUNISTIC_CHARGE に一時遷移 → 共通フロー。CaseAであっても「旅行中に充電不要」とは言わず、最小限＋安全側プランを複数提示。                           | 「せっかく来たからある程度充電する」パターンが多く、安全寄り案を選択 | OPPORTUNISTIC_CHARGE → TRAVEL        | OK（習慣モデルには低重みで学習） |
| E5  | リコメンド無視で充電／スキップ                        | NORMAL or TRAVEL等 | 実際の行動ログ受信（リコメンドと不一致） | 共通フロー外で「差分ログ記録」→ 必要に応じて再評価トリガー（NORMAL/突発/緊急として再度共通フローへ）。状態は基本維持（NORMAL/ TRAVEL）。                                 | ユーザーは自由に行動。次回以降のレコメンド改善のためのデータになる   | 基本は状態維持（NORMAL/ TRAVEL等のまま） | OK（アルゴリズムは破綻しない） |

# 3. 状態 × トリガー → アクティビティ図ブロック対応マトリクス
| 状態                     | トリガー種別                               | アクティビティ図の入口ブロック                            | 備考（モード別ポリシーのポイント）                                         |
|--------------------------|--------------------------------------------|------------------------------------------------------------|----------------------------------------------------------------------------|
| NORMAL                   | 朝一バッチ／通常イベント                   | 「トリガー種別は？ = 通常バッチ/通常イベント」→ NORMAL   | 通常系（N1〜N3）。CaseA/B/C すべてを使い、スキップ含めてバランスよく提案。  |
| NORMAL                   | 予定外の充電開始／「今から充電」ボタン    | 「トリガー種別は？ = 突発/今から充電」→ 突発充電         | 突発系（E1）。タイミングは「今」に固定。CaseAなら「充電不要 or 最小限」。     |
| NORMAL                   | SOC低下イベント（下限付近だがまだ走行可） | 「トリガー種別は？ = 緊急」→ 緊急                         | E2 相当。ただし完全枯渇ではなく、早めの不足予兆。CaseB/C 側を多用。         |
| TRAVEL                   | 朝一バッチ／通常イベント                   | （実装上は NORMAL と同じ入口）→ NORMAL として共通フロー  | TRAVEL状態だが、ポリシーでスキップ抑制・安全側プラン優先。                 |
| TRAVEL                   | 旅行中の充電開始イベント                   | 「トリガー種別は？ = 突発/今から充電」→ 突発充電         | E4。TRAVEL＋OPPORTUNISTIC の組み合わせ。CaseAでも「充電不要」とは言いづらい。|
| TRAVEL                   | SOC低下イベント                            | 「トリガー種別は？ = 緊急」→ 緊急                         | 旅行中の緊急（E2 の TRAVEL版）。不足回避を最優先。                         |
| OPPORTUNISTIC_CHARGE     | 充電セッション中のループ                   | すでに「突発充電」入口から共通フローに入っている          | OPPORTUNISTIC は「状態名」であり、処理は常に共通フロー＋突発ポリシーで実行。|
| OPPORTUNISTIC_CHARGE     | 充電セッション終了                         | アクティビティ図末尾の「ログ記録→状態更新」部分           | 終了後、位置・走行パターンにより NORMAL or TRAVEL へ戻る。                 |
| EMERGENCY_BEFORE_NORMAL  | 緊急充電量レコメンド                       | 「トリガー種別は？ = 緊急」→ 緊急                         | 緊急モード専用ポリシー。スキップ無し。CaseB/C で不足回避案のみ生成。       |
| EMERGENCY_BEFORE_NORMAL  | 緊急充電完了                               | アクティビティ図末尾の「ログ記録→状態更新」部分           | 復帰先は NORMAL or TRAVEL。旅行中なら TRAVEL に戻る。                      |
