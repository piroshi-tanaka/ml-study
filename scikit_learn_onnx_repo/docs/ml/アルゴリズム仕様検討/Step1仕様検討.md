# Step1. モードと推論タイミングの設計原則（テキスト＋状態図）

## 1-1. アルゴリズム内部のモード定義（案）

本ソリューションでは、アルゴリズム内部に少なくとも以下のモードを持つ前提とします。

- `NORMAL`  
  - 普段の習慣に基づく通常運用。
  - 例：金曜夜に自宅で充電、平日朝に通勤、週末は走行少なめなど。
  - スキップ可否判定・次々回までの推論をフル機能で実施。

- `TRAVEL`（旅行モード）  
  - 長距離走行・未知クラスタ滞在などから、通常習慣から乖離している期間。
  - スキップリコメンドは「原則出さない」か「かなり保守的」に抑制。
  - 習慣学習への影響も重みを下げる（ノイズ扱い）。

- `EMERGENCY_BEFORE_NORMAL`（緊急：通常充電前に残量不足）  
  - 例：本来金曜夜まで持つはずが、木曜の時点でこのままだと 0% 近くなると判明。
  - 「とりあえず今充電しないと危ない」状態。
  - ここでの充電量ポリシーは、設計方針として明示：
    - 方針A：次の通常タイミング（金曜）まで持つ量
    - 方針B：次々回（火曜）まで持つ量（今回を実質「次回」とみなす）

- `OPPORTUNISTIC_CHARGE`（突発・たまたま充電）  
  - 例：普段充電しない木曜に、たまたま 40% で空きがあったので充電。
  - SOC的には緊急ではないが、充電イベントが発生。
  - 学習時の重みは小さめに扱い、習慣としてはすぐには反映しない。

- `COLD_START`（任意：データ不足モード）  
  - ユーザ個別データが不足しており、共通モデル＋ルールベースで運用。
  - スキップはより保守的、あるいは行わない。

このモードは **推論ロジックの振る舞いを切り替えるための「内部状態」** として定義します。

## 1-2. 推論・リコメンドのトリガー設計（NORMAL / EMERGENCY）

推論タイミング・リコメンドタイミングの基本方針：

- `NORMAL` モードの主トリガー（例）
  - 毎朝一定時刻に「1日〜数日先までのパターン」をバッチ推論
  - 車両起動時 or アプリ起動時に「現状を踏まえた再評価」

- `EMERGENCY_BEFORE_NORMAL` / `OPPORTUNISTIC_CHARGE` の主トリガー（例）
  - ユーザーアクション：
    - アプリ上の「今から充電するけど、おすすめ充電量を教えて」ボタン押下
  - システムイベント：
    - 充電ケーブル接続検知（充電開始前に即時計算）
    - SOC 残量が安全閾値を下回った／下回りそうなとき（車両側イベント）

このように、「通常は朝一バッチ」「イレギュラーはイベント駆動」の二段構えにしておくと整理しやすくなります。

## 1-3. モードとトリガーの関係（状態図・PlantUML）

```plantuml