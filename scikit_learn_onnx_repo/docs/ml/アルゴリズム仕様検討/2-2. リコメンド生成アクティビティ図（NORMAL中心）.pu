@startuml
start

:入力取得\n- 現在SOC\n- 時刻/曜日\n- 場所クラスタ\n- 直近走行履歴;

:モード判定\n(NORMAL/ TRAVEL/\nEMERGENCY/ OPPORTUNISTIC/\nCOLD_START);

if (モード == COLD_START?) then (yes)
  :ルールベースで\n安全側リコメンド;
  stop
else (no)
endif

if (モード == TRAVEL?) then (yes)
  :TRAVELポリシー適用\n(スキップは原則抑制);
  :次回充電タイミングのみ\n安全側で推定;
  stop
else (no)
endif

if (モード == EMERGENCY_BEFORE_NORMAL?) then (yes)
  :緊急充電ポリシー適用\n(次回まで or 次々回まで);
  :必要な充電量を算出;
  stop
else (no)
endif

if (モード == OPPORTUNISTIC_CHARGE?) then (yes)
  :突発充電イベントとして処理\n(学習重みを小さく);
  :今後のSOC予測を更新し\n次回/次々回候補を再推定;
  :スキップ提案有無を判定;
  stop
else (no)
endif

' ここまで来たら NORMAL
:次回/次々回の充電候補タイミングを予測;
:今から次々回までのSOC消費を予測;

if (次々回まで安全マージン内？) then (yes)
  :「今回スキップ可」をリコメンド;
else (no)
  if (次回までなら安全？) then (yes)
    :「今回少量充電」などの\n保守的リコメンド;
  else (no)
    :「今回しっかり充電」をリコメンド;
  endif
endif

stop
@enduml
