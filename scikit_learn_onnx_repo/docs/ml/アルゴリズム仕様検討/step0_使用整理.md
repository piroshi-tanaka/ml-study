## 1. 新アーキテクチャ：2階層状態管理モデル

システムの複雑な状態を「ベースとなるコンテキスト」と「現在の緊急度ステータス」の掛け合わせで管理する。

### 第1階層：コンテキスト（Base Context）
「ユーザーの生活モード」を定義し、予測アルゴリズムの**種類**と**学習の有無**を決定する。

| コンテキスト | 説明 | 学習への反映 |
|:---|:---|:---|
| `DAILY` (日常・NORMAL) | 通常の習慣データに基づき予測。 | **有効**（今回の行動を習慣として記録） |
| `TRAVEL` (旅行・非日常) | 長距離走行や未知エリア滞在。ナビ情報、一般走行モデルで予測。 | **無効**（ノイズとして除外） |
| `COLD_START` (新規・学習中) | データ不足。ルールベースまたは共通モデルで保守的に運用。 | 新規データの蓄積優先 |

### 第2階層：ステータス（Safety Status）
「SOCに関する現在の危険度・緊急度」を定義し、リコメンドの**強さ**を決定する。

| ステータス | 説明 | アクションの強さ |
|:---|:---|:---|
| `GREEN` (余裕あり) | 予測SOCが安全マージン内。 | スキップ提案、充電上限提案（バッテリー保護） |
| `YELLOW` (乖離検知・注意) | 予測より減りが早い、またはSOCが注意域に接近。 | 再計算、早期充電の提案、リマインド |
| `RED` (緊急・EMERGENCY) | SOC下限突破、または目的地到達不能の危険性。 | 即時充電指令（警告）、スキップ不可 |

---

## 2. トリガー別・処理フローとロジックのマトリクス

トリガーを3つのカテゴリに分け、コンテキストごとの処理内容を定義する。

### カテゴリA：定時・プロアクティブ系 (Planner)

| トリガー例 | コンテキスト | 処理内容 | 出力（目標） |
|:---|:---|:---|:---|
| 朝一バッチ、初回乗車時 | **DAILY** | 習慣予測に基づき、直近の充電予定まで持つか計算。 | 今日の「スキップ可否」を決定 |
| 朝一バッチ、初回乗車時 | **TRAVEL** | 旅程・目的地に基づき、次の経由地まで持つか計算。 | 満充電推奨 or 目的地到達に必要な量 |

### カテゴリB：行動・リアクティブ系 (Event Handler)
**トリガー例:** プラグ接続、ステーションエリア進入。

| 状況判定 | DAILY時の挙動 | TRAVEL時の挙動 | 学習への反映 |
|:---|:---|:---|:---|
| **計画通り**<br>(いつもの場所・時間) | **「習慣充電」として処理**<br>次回・次々回まで持つ推奨量を提案。 | **「経路充電」として処理**<br>次の目的地まで十分な量を計算。 | **DAILY:** 強化<br>**TRAVEL:** 除外 |
| **突発的**<br>(予定外の場所・時間) | **「Opportunistic」として処理**<br>SOCが十分ならスキップ提案 or バッテリー保護の上限提案。 | **「予備充電」として処理**<br>ユーザーの不安解消を優先し、充電を許容。 | **DAILY:** 弱める/除外<br>**TRAVEL:** 除外 |

### カテゴリC：監視・インタラプト系 (Monitor)
**トリガー例:** SOC下限突破、予測減少速度の乖離検知。

| トリガー | 遷移ステータス | アクション | 復帰条件 |
|:---|:---|:---|:---|
| **予測乖離**<br>(減少速度 > 予測) | `GREEN` $\rightarrow$ `YELLOW` | 直近の予定到達可否を再計算。追加充電を提案。 | 再計算の結果余裕あり、または充電によりSOC回復。 |
| **SOC緊急**<br>(下限割れ) | `GREEN/YELLOW` $\rightarrow$ `RED` | 即時充電指令。最短充電スポットへの誘導。スキップ不可。 | SOCが安全閾値（例: 20%）以上に回復。 |

---

## 3. 開発すべきシステム定義（重要設計方針）

1.  **ステートマシンではなく「コンテキスト × ステータス」のマトリクスで実装する。**
    * 複雑なモード遷移の矛盾を防ぎ、判定ロジックをシンプルにする。
2.  **トリガーを「定期（Plan）」「イベント（Do）」「監視（Check）」の3種類に明確に分け、処理を定義する。**
3.  **「学習するかしないか」のフラグ管理を最重要視する。**
    * TRAVEL中や突発充電（Opportunistic）を徹底的に学習データから隔離し、モデルの精度劣化を防ぐ。