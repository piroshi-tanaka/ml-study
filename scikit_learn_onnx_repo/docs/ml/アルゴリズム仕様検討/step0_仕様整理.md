## 1. 新アーキテクチャ：2階層状態管理モデル

システムの複雑な状態を「ベースとなるコンテキスト」と「現在の緊急度ステータス」の掛け合わせで管理する。

### 第1階層：コンテキスト（Base Context）
「ユーザーの生活モード」を定義し、予測アルゴリズムの**種類**と**学習の有無**を決定する。

| コンテキスト | 説明 | 学習への反映 |
|:---|:---|:---|
| `DAILY` (日常・NORMAL) | 通常の習慣データに基づき予測。 | **有効**（今回の行動を習慣として記録） |
| `TRAVEL` (旅行・非日常) | 長距離走行や未知エリア滞在。ナビ情報、一般走行モデルで予測。 | **無効**（ノイズとして除外） |

### 第2階層：ステータス（Safety Status）
「SOCに関する現在の危険度・緊急度」を定義し、リコメンドの**強さ**を決定する。

| ステータス | 説明 | アクションの強さ |
|:---|:---|:---|
| `GREEN` (余裕あり) | 次々回充電タイミングまで到達可能 | スキップ提案、充電上限提案（バッテリー保護） |
| `YELLOW` (乖離検知・注意) | 次回充電タイミングまで到達可能 | 再計算、早期充電の提案、リマインド |
| `RED` (緊急・EMERGENCY) | 次回充電タイミングまで到達不可 | 即時充電指令（警告）、スキップ不可 |

---

## 2. トリガー別・処理フローとロジックのマトリクス

トリガーを3つのカテゴリに分け、コンテキストごとの処理内容を定義する。

### カテゴリA：定時・プロアクティブ系 (Planner)

| トリガー例 | コンテキスト | 処理内容 | 出力（目標） |
|:---|:---|:---|:---|
| 朝一バッチ、初回乗車時 | **DAILY** | 習慣予測に基づき、直近の充電予定まで持つか計算。 | 今日の「スキップ可否」を決定 |
| 朝一バッチ、初回乗車時 | **TRAVEL** | 旅程・目的地に基づき、次の経由地まで持つか計算。 | 満充電推奨 or 目的地到達に必要な量 |

### カテゴリB：行動・リアクティブ系 (Event Handler)
**トリガー例:** プラグ接続、ステーションエリア進入。

| 状況判定 | DAILY時の挙動 | TRAVEL時の挙動 | 学習への反映 |
|:---|:---|:---|:---|
| **計画通り**<br>(いつもの場所・時間) | **「習慣充電」として処理**<br>次回・次々回まで持つ推奨量を提案。 | **「経路充電」として処理**<br>次の目的地まで十分な量を計算。 | **DAILY:** 強化<br>**TRAVEL:** 除外 |
| **突発的**<br>(予定外の場所・時間) | **「Opportunistic」として処理**<br>SOCが十分ならスキップ提案 or バッテリー保護の上限提案。 | **「予備充電」として処理**<br>ユーザーの不安解消を優先し、充電を許容。 | **DAILY:** 弱める/除外<br>**TRAVEL:** 除外 |

### カテゴリC：監視・インタラプト系 (Monitor)
**トリガー例:** SOC下限突破、予測減少速度の乖離検知。

| トリガー | 遷移ステータス | アクション | 復帰条件 |
|:---|:---|:---|:---|
| **予測乖離**<br>(減少速度 > 予測) | `GREEN` $\rightarrow$ `YELLOW` | 直近の予定到達可否を再計算。追加充電を提案。 | 再計算の結果余裕あり、または充電によりSOC回復。 |
| **SOC緊急**<br>(下限割れ) | `GREEN/YELLOW` $\rightarrow$ `RED` | 即時充電指令。最短充電スポットへの誘導。スキップ不可。 | SOCが安全閾値（例: 20%）以上に回復。 |

---

## 3. 開発すべきシステム定義（重要設計方針）

1.  **ステートマシンではなく「コンテキスト × ステータス」のマトリクスで実装する。**
    * 複雑なモード遷移の矛盾を防ぎ、判定ロジックをシンプルにする。
2.  **トリガーを「定期（Plan）」「イベント（Do）」「監視（Check）」の3種類に明確に分け、処理を定義する。**
3.  **「学習するかしないか」のフラグ管理を最重要視する。**
    * TRAVEL中や突発充電（Opportunistic）を徹底的に学習データから隔離し、モデルの精度劣化を防ぐ。


## 📑 階層的ディシジョンマトリクス（PoC設計図）

ご提示いただいた「EVバッテリ劣化抑制のための最適SOC誘導型リコメンデーション」ソリューションに基づき、プロジェクトの核となるディシジョンマトリクスを、**トリガー、コンテキスト、および機械学習予測**の結果を統合した形で網羅的に整理します。

このマトリクスは、**機械学習モデルの予測結果**（レベル2）と**2階層状態管理モデル**（レベル1）を組み合わせて、最終アクション（レベル3）を決定するものです。

---

### 1. レベル1：トリガーとコンテキストの特定

| トリガーカテゴリ | 処理機能 | 発動タイミング例 | 決定事項 |
|:---|:---|:---|:---|
| A. Planner | 習慣計画（サーバー） | 毎日定時（例: 04:00 AM）、初回乗車前 | プロアクティブな最適化リコメンドを準備 |
| B. Event Handler | 行動反応（車載/サーバー） | プラグ接続時、充電エリア進入、ユーザーリクエスト時 | リアクティブな最適化リコメンドを準備/実行 |
| C. Monitor | 状態監視（車載） | SOC下限突破、SOC減少速度乖離検知 | 安全確保のための介入（YELLOW/REDへの遷移） |

**決定事項：** 現在のコンテキスト（`DAILY`/`TRAVEL`/`COLD_START`）と、安全ステータス（`GREEN`/`YELLOW`/`RED`）を決定する。

### 2. レベル2：機械学習予測に基づく安全マージンの評価（$T_{\text{charge}} + \Delta \text{SOC}$ の統合）

| 安全ステータス | 定義（機械学習予測に基づく） | リコメンドの方向性 |
|:---|:---|:---|:---|
| GREEN (余裕あり) | **現在のSOC** $-$ **次々回までの $\Delta \text{SOC}$** $>$ **安全閾値**（例: 20%） | バッテリ保護のため、スキップまたは上限設定を提案。 |
| YELLOW (注意) | **現在のSOC** $-$ **次々回までの $\Delta \text{SOC}$** $\le$ **安全閾値** だが、**緊急閾値**（例: 10%）よりは上 | 早期充電を提案、または今回のスキップは非推奨。 |
| RED (緊急) | **現在のSOC** $-$ **次回までの $\Delta \text{SOC}$** $\le$ **緊急閾値**（例: 10%） | 即時充電を指令。 |
| 判定不能 | $T_{\text{charge}}$ または $\Delta \text{SOC}$ の予測精度が低い、またはデータ不足（`COLD_START`） | ルールベースまたは保守的な充電を提案。 |

### 3. レベル3：最終リコメンドアクションの決定（網羅的マトリクス）

このマトリクスは、トリガーカテゴリ、コンテキスト、ステータスを組み合わせ、最終的なアクションを網羅的に定義します。

| トリガー | コンテキスト | ステータス | 処理内容 | 最終アクション（リコメンド） | 学習への反映 |
|:---|:---|:---|:---|:---|:---|
| **A. Planner** (朝一) | **DAILY** | **GREEN** | 習慣予測: 次々回まで持つ。 | **充電スキップ推奨** or **上限SOC**（例: 70%）提案。 | **強化**（習慣として記録）。 |
| **A. Planner** (朝一) | **DAILY** | **YELLOW** | 習慣予測: 次々回までマージンがタイト。 | **スキップ非推奨**。次回充電の確実な実行をリマインド。 | `YELLOW`脱出後に`DAILY`として記録。 |
| **A. Planner** (朝一) | **DAILY** | **RED** | 習慣予測: 次回・次々回までにSOC不足が予測。 | **即時充電を指令**。スキップ不可。 | 無効（モデル予測失敗の記録）。 |
| **A. Planner** (朝一) | **TRAVEL** | **全** | 旅程予測: ナビ情報に基づき計算。 | 目的地到達に必要な**必要充電量**を提案。 | 無効（ノイズとして除外）。 |
| **A. Planner** (朝一) | **COLD\_START** | **全** | 初期ルールベース適用（データ不足）。 | **保守的な充電**を提案（例: 50%を下回っていたら充電推奨）。 | データ蓄積のみ。 |
|---|---|---|---|---|---|
| **B. Event Handler** (習慣充電) | **DAILY** | **GREEN** | 次々回まで持つか再計算。 | **スキップ推奨** or **上限SOC**（例: 80%）を提案。 | **強化**（習慣として記録）。 |
| **B. Event Handler** (習慣充電) | **DAILY** | **YELLOW** | 満充電で次々回まで余裕確保が必要。 | **満充電を推奨**。 | 無効（安全優先）。 |
| **B. Event Handler** (突発充電) | **DAILY** | **GREEN** | SOCが十分（突発充電の必要性低）。 | **充電スキップ**（過剰充電抑制）を提案。 | 無効（ノイズとして除外）。 |
| **B. Event Handler** (全状況) | **TRAVEL** | **全** | 次の目的地までの必要充電量を計算。 | **経路充電**として次の目的地までの量を提案。 | 無効（ノイズとして除外）。 |
| **B. Event Handler** (全状況) | **COLD\_START** | **全** | 初期ルールベース適用。 | **保守的な充電**を提案。 | データ蓄積のみ。 |
|---|---|---|---|---|---|
| **C. Monitor** (予測乖離) | **DAILY/TRAVEL** | `GREEN` $\rightarrow$ **YELLOW** | 直近の予定到達可否を再計算。 | **早期充電**または**航続可能距離の再確認**を提案。 | 無効（監視・介入）。 |
| **C. Monitor** (SOC緊急) | **DAILY/TRAVEL** | `GREEN/YELLOW` $\rightarrow$ **RED** | **すべての予測を停止**。緊急対応に切り替え。 | **🚨 即時充電を指令**。最短充電スポットへ誘導。スキップ不可。 | 無効（緊急対応）。 |
| **C. Monitor** (コンセプトドリフト) | **DAILY** | **全** | モデル予測誤差が閾値を連続超過。 | **モデル更新/再学習**をトリガー。 | - |
