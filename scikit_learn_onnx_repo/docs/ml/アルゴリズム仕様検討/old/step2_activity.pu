@startuml
skinparam activityStyle rounded
skinparam shadowing false

'==========================
' トリガー部
'==========================
|トリガー|
start
:トリガー発生\n(朝一バッチ / 通常イベント /\n予定外の充電開始 / 「今から充電」 /\nSOC低下イベント / リコメンド無視検知);

if (トリガー種別は？) then (通常バッチ/通常イベント)
  :リコメンドモード = NORMAL;
  note right
    NORMALスタート:
    - 朝一バッチ
    - 走行終了などの通常イベント
    を起点に、「次回/次々回の
    充電タイミング＋量」を
    標準ポリシーで判定する。
  end note

elseif (予定外の充電開始\nまたは「今から充電」) then (突発/今から充電)
  :リコメンドモード = 突発充電;
  note right
    突発スタート:
    - いつもと違う曜日/時間/場所での充電開始
    - アプリの「今から充電」ボタン
    を起点に、「今回の充電量」を
    中心にレコメンドする。
    タイミングは「今」に固定される。
  end note

elseif (SOC低下イベント) then (緊急)
  :リコメンドモード = 緊急;
  note right
    緊急スタート:
    - SOCが閾値を下回りそう
    - 予測より大きくSOCが低下
    を起点に、「不足させないこと」を
    最優先に充電タイミングと量を決める。
  end note

elseif (リコメンド無視が判明) then (リコメンド無視)
  :直近のリコメンドと\n実際の行動の差分を記録;
  :現在のSOC・時刻・位置から\n改めてモードを再判定\n(NORMAL/突発/緊急);
else (その他)
  :特別なレコメンドは不要\n(ログのみ記録);
  stop
endif

'==========================
' 共通：充電リコメンドフロー
'==========================
|充電リコメンドシステム|
:入力取得\n(現在SOC, 時刻, 曜日,\n位置, 充電/走行履歴,\n今後の利用見込み など);

:モード別ポリシー設定;
note right
  リコメンドモードに応じて、
  - 許可するアクション
    (スキップ可/不可, 今回のみ充電 など)
  - SOC下限マージンの厚さ
  - おすすめプランの選び方
    NORMAL : バッテリ負担と安心感のバランス
    突発   : バッテリ負担が小さい案を優先
    緊急   : 不足しない案を最優先
  を切り替える。
  以降の判定フローは共通。
end note

'--- 1. 次々回までの充電タイミング予測 ---
:次々回までの充電タイミングを予測\n→ 次回充電タイミング,\n   次々回充電タイミング;

'--- 2. 次々回までの消費SOC予測 ---
:次々回までの消費SOCを予測\n→ 次回までの消費SOC,\n   次々回までの消費SOC;

'--- 3. SOC見込み値の計算 ---
:次回後SOC  = 現在SOC - 次回までの消費SOC;
:次々回後SOC = 現在SOC - 次々回までの消費SOC;

'==========================
' ケースA: 次々回まで到達可能
'==========================
if (次々回後SOC >= SOC下限？) then (はい)
  :ケースA: 何も充電しなくても\n次々回まで到達可能と判定;

  :複数プランを計算;
  note right
    例) ケースAで計算するプラン
    - プラン1: 今回は充電しない
      (現状のままでも次々回まで到達)
    - プラン2: 不安な人向けの
      「少量だけ充電」プラン
    - プラン3: 次々回のタイミングで、
      バッテリに優しい上限SOCまで充電
    NORMAL では主にプラン1/3、
    突発   ではプラン1/2 を
    おすすめ候補にしやすい。
  end note

  :各プランごとに\n必要充電量とバッテリ負担度合い\n(高SOC滞在時間など)を評価;

  :モード別ポリシーに従い\n「おすすめプラン」を選択\n(他のプランも併記);

'==========================
' ケースB/C: 次々回まで到達不可
'==========================
else (いいえ)

  '--- 5. ケースB: 次回までは到達可能 ---
  if (次回後SOC >= SOC下限？) then (はい)
    :ケースB: 次回までは到達可能\n(次々回までは不足);

    :複数プランを計算;
    note right
      例) ケースBで計算するプラン
      - プラン1: 次回の通常タイミングで
        「次回まで確実に持たせる」充電量
      - プラン2: 次回で
        「次々回まで確実に持たせる」充電量
      - プラン3: その中間レベルで
        バッテリ負担を抑えた充電量
      いずれも、必要充電量と
      バッテリ負担度合いを評価する。
    end note

    :各プランの評価結果から\nおすすめプランを選択\n(モード別ポリシーで重み付け);

  else (いいえ)
    '--- 6. ケースC: 次回までにSOC下限を割る ---
    :ケースC: 次回の通常タイミングまでに\nSOC下限を割り込む見込み;

    :SOC下限を下回る最初の日時\n(枯渇予測時刻)を計算;
    :枯渇予測時刻より前の\n候補充電タイミング一覧を生成\n(例:前日夜, 当日朝, 今回など);

    if (候補充電タイミングが\n1つ以上あるか？) then (はい)
      :ユーザー習慣や現実性を考慮し\n有力な候補時刻を複数選択;

      :候補時刻 × 複数プランを計算;
      note right
        例) 各候補時刻ごとに
        - プラン1: 枯渇予測時刻まで
          SOC下限を割らない最低充電量
        - プラン2: 次回の通常充電まで
          確実に持たせる充電量
        - プラン3: 次々回の通常充電まで
          確実に持たせる充電量
        を計算し、必要充電量と
        バッテリ負担度合いを評価する。
        緊急モードでは「不足しない」
        プランを優先、おすすめとする。
      end note

      :モード別ポリシーに従い\n「特に推奨するプラン」を決定し、\n他プランも合わせて提示;

    else (候補なし)
      :非常に危険な状況とみなし\n最寄りでの充電を強く推奨;
      :最寄りの充電機会で\n枯渇を確実に避けるための\n最低限の充電量を計算;
      :この緊急プランを\nおすすめプランとして設定;
    endif

  endif
endif

:レコメンド内容を構造化\n(タイミング候補, 各プランの充電量,\n 理由, 安全マージン, 使用ポリシー,\n システムがおすすめするプラン);

|モバイルアプリ|
:レコメンド結果を一覧表示\n(複数プラン＋おすすめ印);

|ユーザー|
:自分の都合と好みに合う\nプランを選択;
if (選択プランに従うか？) then (はい)
  :選択したプランに従い\n指定タイミング・量で\n充電/スキップを実行;
else (いいえ)
  :ユーザー判断で\n別タイミング/別量で\n充電 or スキップ;
endif

|車両/車載システム|
:実際の行動ログを送信\n(SOC推移, 充電量, タイミングなど);

|充電リコメンドシステム|
:レコメンドと実績の差分を記録\n(選択されたプランも含め保存);

stop
@enduml
