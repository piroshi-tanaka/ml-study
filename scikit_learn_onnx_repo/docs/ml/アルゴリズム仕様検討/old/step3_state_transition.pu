## 1. 状態遷移図（COLD_START除外版）

今回の前提：「モデルはすでに動作しており、個別データもそこそこ存在する」  
→ `COLD_START` は状態としては定義せず、必要なら NORMAL 内部のポリシー（データ不足フラグ）で扱う。

```plantuml
@startuml
skinparam shadowing false

'====================================
' 内部モードの状態遷移図（COLD_STARTなし）
'====================================

[*] --> S_NORMAL : 初期化/モデル起動\n(通常運用開始)

state "NORMAL\n(通常習慣ベース)" as S_NORMAL
state "TRAVEL\n(旅行・イレギュラー)" as S_TRAVEL
state "EMERGENCY_BEFORE_NORMAL\n(通常充電前の緊急不足)" as S_EMERGENCY
state "OPPORTUNISTIC_CHARGE\n(突発充電セッション)" as S_OPPORTUNISTIC

note right of S_NORMAL
  ・曜日/時間帯/場所ごとの通常充電タイミングを学習した状態
  ・「次回/次々回までの到達可否」を判定し、
    スキップ or 充電タイミング＋量をレコメンド
  ・データが少ない期間は、内部フラグとして
    「データ不足モード」を持ち、
    スキップ抑制など安全側ポリシーで運用する
end note

note right of S_TRAVEL
  ・長距離走行や未知クラスタ滞在など、
    普段と大きく異なるパターンを検知した状態
  ・スキップリコメンドを抑制し、
    「減ったら充電」寄りの安全挙動を優先
end note

note right of S_EMERGENCY
  ・本来の次回通常充電タイミングの前に
    SOC下限割れ予測 or SOC低下イベントが発生
  ・不足を起こさないことを最優先に、
    できるだけ早い充電と必要量をレコメンド
end note

note right of S_OPPORTUNISTIC
  ・いつもの習慣と異なるタイミング/場所で
    ユーザーが充電を開始した状態
  ・タイミングは「今」に固定し、
    今回の充電量のみを最適化
  ・学習時は習慣モデルへの影響を小さめに扱う
end note

'------------------------------------
' NORMAL と TRAVEL 間の遷移
'------------------------------------
S_NORMAL --> S_TRAVEL : 長距離走行/未知クラスタ滞在\n普段と異なる走行パターンを連続検知
S_TRAVEL --> S_NORMAL : 自宅クラスタでの夜間長時間駐車が\n複数日続く 等\n「習慣パターンへの復帰」を検知

'------------------------------------
' NORMAL/TRAVEL から EMERGENCY への遷移
'------------------------------------
S_NORMAL --> S_EMERGENCY : 次回通常充電前に\nSOC下限割れ予測 or SOC低下イベント
S_TRAVEL --> S_EMERGENCY : 旅行中にSOC低下イベント\n(予測より大きな消費)

' 緊急充電後の復帰
S_EMERGENCY --> S_NORMAL : 緊急充電完了後\n自宅周辺での通常パターンに復帰
S_EMERGENCY --> S_TRAVEL : 緊急充電後も\n旅行パターンが継続

'------------------------------------
' OPPORTUNISTIC との遷移
'------------------------------------
S_NORMAL --> S_OPPORTUNISTIC : 予定外タイミングでの充電開始\nまたは「今から充電」ボタン押下
S_TRAVEL --> S_OPPORTUNISTIC : 旅行中のサービスエリア等で\n突発的に充電開始

S_OPPORTUNISTIC --> S_NORMAL : 充電セッション終了後、\n自宅クラスタに戻り\n通常パターンが継続
S_OPPORTUNISTIC --> S_TRAVEL : 充電セッション終了後も\n長距離移動や未知クラスタ滞在が継続

@enduml
