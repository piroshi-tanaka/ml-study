# Step3. 決定表とインバリアント（安全条件）の定義

## 3-1. 代表的な決定表（緊急時・突発時を含む）

### 3-1-1. モード判定の決定表（例）

| 条件                                                         | 判定                                   | モード                 |
|--------------------------------------------------------------|----------------------------------------|------------------------|
| 個人データ量が閾値未満                                      | Yes                                    | COLD_START             |
| 直近 X 日の総走行距離が平常の k 倍以上                      | Yes                                    | TRAVEL                 |
| 通常ではないクラスタに長時間滞在                            | Yes                                    | TRAVEL                 |
| 予測していたSOCよりも実測SOCが一定以上早く減少             | Yes（かつ TRAVEL 条件は満たさず）     | EMERGENCY_BEFORE_NORMAL |
| 通常の曜日・時間帯・場所ではないが充電イベントが発生       | Yes（かつ緊急SOC条件は満たさず）      | OPPORTUNISTIC_CHARGE   |
| 上記のいずれにも該当しない                                  | -                                      | NORMAL                 |

### 3-1-2. EMERGENCY 時の充電量決定表（例）

| 条件                                            | 判定                            | 推奨充電量ポリシー例                                   |
|-------------------------------------------------|---------------------------------|--------------------------------------------------------|
| 方針 = A（次回まで）                            | -                               | 次の「通常充電タイミング」まで安全に持つ量            |
| 方針 = B（次々回まで）                          | -                               | 次々回通常タイミングまで安全に持つ量                  |
| TRAVEL モードかつ充電機会が限られそう           | Yes                             | 方針B + 旅行特有の余裕マージン                        |
| 直近の予測誤差が大きい（不確実性が高い）        | Yes                             | 方針A/Bいずれにせよさらに安全側へマージン上乗せ       |

※ PoC では、「方針Aを採用する理由」「方針Bを採用する理由」を設計上明記し、  
どのユースケースでどちらを採用するかをドキュメントに落としておく。

## 3-2. インバリアント（常に守りたい性質）

インバリアント（不変条件）の例：

- Inv1. どのモードでも、  
  「推奨行動に従った場合、**少なくとも次回 or 直近安全期限まで** SOC が安全閾値を下回らない」
- Inv2. `TRAVEL` / `EMERGENCY_BEFORE_NORMAL` / `COLD_START` では、  
  「`NORMAL` よりも保守的（スキップ提案の頻度が少ない or 充電量が多い）」である
- Inv3. `OPPORTUNISTIC_CHARGE` のイベントは、  
  「単発では**習慣モデルを大きく書き換えない**（学習重みを制限）」  
  → 何回も繰り返されるときのみ習慣と認識される
- Inv4. `TRAVEL` 終了後、一定期間の平常パターンが観測されれば必ず `NORMAL` に戻る  
  → 旅行などのイレギュラーから必ず復帰できる

後の Step4・シミュレーションを通じて、「このインバリアントが破られていないか？」をチェックする。

---

# Step4. シナリオカバレッジ表＋手動トレース

## 4-1. シナリオカバレッジ表（代表ユースケース＋イレギュラー）

代表ユースケースとイレギュラーを混ぜたシナリオを、  
「どのモードで開始し、どのアクティビティフローを通り、どの状態に戻るか」で整理。

### 4-1-1. カバレッジ表（例）

| No | シナリオ概要                                           | 初期モード | 主なイベント                                | 通過するアクティビティパス（Step2参照）                                      | 最終モード          | インバリアント確認ポイント                     |
|----|--------------------------------------------------------|------------|---------------------------------------------|-------------------------------------------------------------------------------|---------------------|-----------------------------------------------|
| 1  | 毎週金曜夜に自宅で充電（NORMALのみ）                  | NORMAL     | 朝一バッチ、金曜夜自宅充電                 | 入力取得 → モード判定(NORMAL) → 通常フロー → スキップ判定                   | NORMAL              | Inv1,2                                     |
| 2  | 木曜に突発40%充電 → 金曜充電スキップ判定             | NORMAL     | 木曜突発充電イベント                       | NORMAL → OPPORTUNISTIC_CHARGE → 再予測 → スキップ判定 → NORMAL              | NORMAL              | Inv1,3（習慣を壊していないか）              |
| 3  | 金曜まで持つはずが木曜に残量不足（緊急）             | NORMAL     | SOC急減、木曜時点で危険域                 | NORMAL → EMERGENCY_BEFORE_NORMAL → 緊急充電ポリシー適用 → NORMAL/ TRAVEL   | NORMAL or TRAVEL    | Inv1,2,4                                   |
| 4  | 3日間の旅行（長距離＋未知クラスタ）                  | NORMAL     | 長距離走行連続、未知クラスタ滞在           | NORMAL → TRAVEL → TRAVELフロー（スキップ抑制） → NORMAL復帰                 | NORMAL              | Inv1,2,4                                   |
| 5  | 旅行中にサービスエリアで突発充電                     | TRAVEL     | TRAVEL中の充電イベント                     | TRAVEL → OPPORTUNISTIC_CHARGE → 旅行継続のため TRAVEL に戻る               | TRAVEL              | Inv1,3,4                                   |
| 6  | 新規ユーザでデータ不足（COLD_START）                 | COLD_START | 少量走行・充電イベント                     | COLD_START → ルールベース → COLD_START継続 or NORMALへ遷移                  | COLD_START or NORMAL | Inv1,2                                   |

この表をもとに、「ユースケース図上のどのユースケースが、どのシナリオでカバーされているか」をチェックする。

